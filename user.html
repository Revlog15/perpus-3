<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E-Perpus - Main Menu User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f6fa;
    }
    .sidebar {
      height: 100vh;
      background: #1e3d59;
      color: #fff;
      padding: 20px 10px;
      position: fixed;
      width: 220px;
    }
    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .sidebar a:hover {
      background: #3a506b;
    }
    .content {
      margin-left: 240px;
      padding: 20px;
    }
    .card-info {
      border-radius: 12px;
      padding: 20px;
      color: #fff;
    }
    .card-blue { background: #007bff; }
    .card-orange { background: #ff8c42; }
    .card-green { background: #4caf50; }
    .hero {
      background: linear-gradient(135deg, rgba(30,61,89,0.85), rgba(0,123,255,0.75)), url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop') center/cover no-repeat;
      border-radius: 16px;
      color: #fff;
      padding: 28px;
      min-height: 160px;
      display: flex;
      align-items: center;
    }
    .hero h4 { margin: 0 0 6px 0; }
    .hero p { margin: 0; opacity: 0.95; }
    .popular-books .card { 
      height: 100%; 
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease; 
      cursor: pointer; 
    }
    .popular-books .card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
    }
    .popular-books .card-img-top { 
      height: 180px; 
      object-fit: cover; 
      transition: transform 0.3s ease; 
    }
    .popular-books .card:hover .card-img-top { 
      transform: scale(1.03); 
    }
    .popular-books .card-title {
      font-size: 0.9rem;
      line-height: 1.3;
      margin-bottom: 0.5rem;
    }
    .popular-books .card-text {
      font-size: 0.8rem;
      line-height: 1.4;
    }
    .popular-books .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h4 class="text-center mb-4">📚 PERPUS ISLAM</h4>
    <a href="#">🏠 Home</a>
    <a href="#submenuDaftar" data-bs-toggle="collapse" aria-expanded="false">📖 Daftar Buku</a>
    <div id="submenuDaftar" class="collapse ms-3">
      <a href="#searchSemuaBuku" data-bs-toggle="collapse" aria-expanded="false">📚 Semua Buku</a>
      <a href="#">✅ Buku Tersedia</a>
      <a href="#">🆕 Buku Terbaru</a>
    </div>
    <a href="#submenuPinjam" data-bs-toggle="collapse" aria-expanded="false">📥 Pinjam Buku</a>
    <div id="submenuPinjam" class="collapse ms-3">
      <a href="#" data-bs-toggle="modal" data-bs-target="#pinjamModal">➕ Form Pinjam</a>
      <a href="#" onclick="loadLoanStatus()">📊 Status Peminjaman</a>
    </div>
    <a href="#" data-bs-toggle="modal" data-bs-target="#pengembalianModal">↩️ Pengembalian Buku</a>
    <a href="#" onclick="loadLoanHistory()">🕓 Riwayat Peminjaman</a>
    <a href="#" class="text-danger fw-bold" data-bs-toggle="modal" data-bs-target="#logoutModal">🚪 Logout</a>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Halo, Andiva 👋</h3>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">👤 Andiva</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#">Profile User</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">Logout</a></li>
        </ul>
      </div>
    </div>
    <div id="searchSemuaBuku" class="collapse mb-3">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Cari buku (judul, penulis, ISBN)..." aria-label="Cari buku">
        <button class="btn btn-primary" type="button">Cari</button>
      </div>
    </div>

    <div class="hero mb-4">
      <div>
        <h4>Selamat datang di PERPUS ISLAM</h4>
        <p>Temukan inspirasi dari ribuan koleksi buku digital kami.</p>
      </div>
    </div>

    <!-- Tentang Perpustakaan -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">Tentang PERPUS ISLAM</h5>
        <p class="card-text mb-2">Selamat datang di PERPUS ISLAM, perpustakaan digital yang membantu Anda menemukan, meminjam, dan mengembalikan buku dengan mudah. Nikmati kemudahan akses koleksi kami kapan saja dan di mana saja.</p>
        <ul class="mb-0">
          <li>Akses cepat ke semua koleksi dan buku terbaru</li>
          <li>Peminjaman online dengan status peminjaman yang jelas</li>
          <li>Notifikasi jatuh tempo dan informasi denda terkini</li>
        </ul>
      </div>
    </div>

    <!-- Dashboard Info -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card-info card-blue">
          <h6>Buku Dipinjam</h6>
          <h3>2</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-info card-orange">
          <h6>Denda Saat Ini</h6>
          <h3>Rp 5.000</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-info card-green">
          <h6>Jatuh Tempo Terdekat</h6>
          <p>Matematika Lanjut<br><small>3 hari lagi</small></p>
        </div>
      </div>
    </div>

  

    <!-- Buku Section -->
    <h5 id="sectionTitle">Buku Populer Minggu Ini</h5>
    <div class="row popular-books">
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/8231856-L.jpg" class="card-img-top" alt="Atomic Habits">
          <div class="card-body p-2 text-center">
            <small>Atomic Habits</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/9259251-L.jpg" class="card-img-top" alt="The Midnight Library">
          <div class="card-body p-2 text-center">
            <small>The Midnight Library</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/11153284-L.jpg" class="card-img-top" alt="sapiens">
          <div class="card-body p-2 text-center">
            <small>Sapiens</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/10909258-L.jpg" class="card-img-top" alt="Becoming">
          <div class="card-body p-2 text-center">
            <small>Becoming</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/12880737-L.jpg" class="card-img-top" alt="Educated">
          <div class="card-body p-2 text-center">
            <small>Educated</small>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card">
          <img src="https://covers.openlibrary.org/b/id/12604065-L.jpg" class="card-img-top" alt="The Alchemist">
          <div class="card-body p-2 text-center">
            <small>The Alchemist</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Konfirmasi Logout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">Apakah Anda serius mau logout?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tidak</button>
          <a href="#" class="btn btn-danger">Ya, Logout</a>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookModalTitle">Detail Buku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4">
              <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:180px">
                <i class="fas fa-book fa-3x text-muted"></i>
              </div>
            </div>
            <div class="col-md-8">
              <h5 id="bookTitle" class="mb-1"></h5>
              <p class="mb-2"><small class="text-muted" id="bookAuthor"></small></p>
              <p id="bookSynopsis" class="mb-2"></p>
              <div class="small text-secondary">
                <span id="bookPublisher" class="me-3"></span>
                <span id="bookYear" class="me-3"></span>
                <span id="bookStock"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-primary" onclick="openPinjamModal()">Pinjam Buku</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Pinjam Buku -->
  <div class="modal fade" id="pinjamModal" tabindex="-1" aria-labelledby="pinjamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pinjamModalLabel">Form Pinjam Buku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="pinjamForm">
            <div class="mb-3">
              <label for="pinjamIdBuku" class="form-label">ID Buku</label>
              <input type="text" class="form-control" id="pinjamIdBuku" name="idBuku" required>
              <div class="form-text">Masukkan ID buku yang ingin dipinjam (contoh: B001)</div>
            </div>
            <div class="mb-3">
              <label for="pinjamNama" class="form-label">Nama Peminjam</label>
              <select class="form-select" id="pinjamNama" name="nama" required>
                <option value="">Pilih nama peminjam</option>
                <option value="Andiva">Andiva</option>
                <option value="Budi Santoso">Budi Santoso</option>
                <option value="Siti Nurhaliza">Siti Nurhaliza</option>
              </select>
            </div>
            <div id="pinjamMessage" class="mt-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" onclick="submitPinjam()">Pinjam Buku</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Pengembalian Buku -->
  <div class="modal fade" id="pengembalianModal" tabindex="-1" aria-labelledby="pengembalianModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pengembalianModalLabel">Form Pengembalian Buku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="pengembalianForm">
            <div class="mb-3">
              <label for="pengembalianIdBuku" class="form-label">ID Buku</label>
              <input type="text" class="form-control" id="pengembalianIdBuku" name="idBuku" required>
              <div class="form-text">Masukkan ID buku yang akan dikembalikan (contoh: B001)</div>
            </div>
            <div class="mb-3">
              <label for="pengembalianNama" class="form-label">Nama Peminjam</label>
              <select class="form-select" id="pengembalianNama" name="nama" required>
                <option value="">Pilih nama peminjam</option>
                <option value="Andiva">Andiva</option>
                <option value="Budi Santoso">Budi Santoso</option>
                <option value="Siti Nurhaliza">Siti Nurhaliza</option>
              </select>
            </div>
            <div id="pengembalianMessage" class="mt-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" onclick="submitPengembalian()">Kembalikan Buku</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API Base URL
    const API_BASE = 'http://localhost:3001/api';
    
    // Global books array
    let books = [];
    
    // Synopsis map (sinopsis singkat)
    const BOOK_SYNOPSIS = {
      'Laskar Pelangi': 'Novel inspiratif tentang perjuangan sepuluh anak Belitung di sekolah sederhana; persahabatan, optimisme, dan kekuatan pendidikan.',
      'Bumi Manusia': 'Kisah cinta Minke dan Annelies di tengah penindasan kolonial; potret perlawanan terhadap ketidakadilan.',
      'Negeri 5 Menara': 'Enam santri yang memegang prinsip man jadda wajada; mimpi, persahabatan, dan daya juang.',
      'Ayat-Ayat Cinta': 'Romansa religius Fahri di Mesir; ujian cinta dan iman dengan nilai moral-spiritual.',
      'Filosofi Kopi': 'Kumpulan cerita seputar Ben sang barista; refleksi hidup sederhana namun dalam melalui secangkir kopi.',
      'Perahu Kertas': 'Perjalanan Keenan dan Kugy mencari jati diri, mimpi, dan cinta; kisah coming-of-age.',
      'Pulang': 'Bujang dan organisasi rahasia; aksi, persahabatan, serta pencarian identitas.',
      'Orang-Orang Biasa': 'Sekelompok orang kecil mencoba mengubah nasib; persahabatan, mimpi, dan perjuangan.',
      'Tentang Kamu': 'Pengacara muda mengurai warisan misterius; kisah hidup penuh pelajaran berharga.',
      'Hujan': 'Lail dan Esok di masa depan yang dilanda bencana; cinta, kehilangan, dan ketabahan.',
      'Rindu': 'Para jamaah haji abad ke-19; rahasia, penyesalan, dan harapan selama pelayaran panjang.',
      'Cantik Itu Luka': 'Magis realisme tentang Dewi Ayu; satir sejarah, cinta, dan luka bangsa.',
      'Sejarah Dunia yang Disembunyikan': 'Nonfiksi teori alternatif sejarah; sisi tersembunyi peradaban, keyakinan, dan kuasa.',
      'Atomic Habits': 'Panduan kebiasaan kecil berdampak besar; bangun kebiasaan baik, hilangkan yang buruk.',
      'Sapiens': 'Perjalanan Homo sapiens hingga modern; budaya, agama, dan sains membentuk peradaban.',
      'Homo Deus': 'Gagasan masa depan manusia, AI, dan bioteknologi; arah peradaban yang menggugah.',
      'The Power of Habit': 'Bagaimana kebiasaan terbentuk dan berubah; contoh dari individu hingga perusahaan.',
      'Rich Dad Poor Dad': 'Kontras pola pikir uang; pelajaran finansial menuju kebebasan keuangan.',
      'Think and Grow Rich': 'Klasik motivasi pola pikir sukses; wawancara tokoh kaya pada masanya.',
      '7 Habits of Highly Effective People': 'Tujuh kebiasaan untuk efektivitas pribadi; fokus pada diri, waktu, dan relasi.'
    };

    function openBookModal(book) {
      const titleEl = document.getElementById('bookModalTitle');
      const h5Title = document.getElementById('bookTitle');
      const authorEl = document.getElementById('bookAuthor');
      const synEl = document.getElementById('bookSynopsis');
      const pubEl = document.getElementById('bookPublisher');
      const yearEl = document.getElementById('bookYear');
      const stockEl = document.getElementById('bookStock');

      const synopsis = BOOK_SYNOPSIS[book.namaBuku] || BOOK_SYNOPSIS[(book.namaBuku || '').split(':')[0]] || 'Sinopsis belum tersedia.';

      titleEl.textContent = 'Detail Buku';
      h5Title.textContent = book.namaBuku;
      authorEl.textContent = `Penulis: ${book.penulis}`;
      synEl.textContent = synopsis;
      pubEl.textContent = `Penerbit: ${book.penerbit}`;
      yearEl.textContent = `Tahun: ${book.tahunTerbit}`;
      stockEl.textContent = `Stok: ${book.stok}`;

      // tampilkan cover di modal
      const coverCol = document.querySelector('#bookModal .col-md-4 > div');
      if (coverCol) {
        const imgSrcJpg = getBookImageSrc(book);
        const imgSrcPng = imgSrcJpg.replace(/\.jpg$/i, '.png');
        coverCol.innerHTML = `<img src="${imgSrcJpg}" alt="${book.namaBuku}" class="img-fluid rounded" onerror="this.onerror=null;this.src='${imgSrcPng}';">`;
      }

      const modal = new bootstrap.Modal(document.getElementById('bookModal'));
      modal.show();
    }

    // Helper: sanitasi nama file dan path gambar lokal
    function sanitizeForFilename(str) {
      return (str || '')
        .toString()
        .normalize('NFKD')
        .replace(/[^\w\s-]/g, '')
        .trim()
        .replace(/[\s_]+/g, '-')
        .toLowerCase();
    }
    function getImageCandidates(book) {
      const baseDir = 'images';
      const title = book?.namaBuku || '';
      const rawJpg = `${baseDir}/${title}.jpg`;
      const rawPng = `${baseDir}/${title}.png`;
      const sanitized = sanitizeForFilename(title);
      const sanJpg = `${baseDir}/${sanitized}.jpg`;
      const sanPng = `${baseDir}/${sanitized}.png`;
      return [rawJpg, rawPng, sanJpg, sanPng];
    }
    // For modal cover: pick a reasonable default; inline onerror will try PNG
    function getBookImageSrc(book) {
      const candidates = getImageCandidates(book);
      // Prefer sanitized JPG first
      return candidates[2];
    }
    function setBookImage(imgEl, book) {
      const candidates = getImageCandidates(book);
      let idx = 0;
      function tryNext() {
        if (idx >= candidates.length) {
          imgEl.onerror = null;
          imgEl.src = 'https://via.placeholder.com/300x180?text=No+Image';
          return;
        }
        const src = candidates[idx++];
        // Encode spaces safely but keep slashes
        const parts = src.split('/');
        parts[parts.length - 1] = encodeURIComponent(parts[parts.length - 1]);
        imgEl.src = parts.join('/');
      }
      imgEl.onerror = tryNext;
      tryNext();
    }
    
    // Load user data
    async function loadUserData() {
      try {
        const response = await fetch(`${API_BASE}/user`);
        const user = await response.json();
        
        // Update user name in header
        document.querySelector('h3').textContent = `Halo, ${user.nama} 👋`;
        document.querySelector('.dropdown-toggle').textContent = `👤 ${user.nama}`;
        
        // Update dashboard info
        document.querySelector('.card-blue h3').textContent = user.bukuDipinjam;
        document.querySelector('.card-orange h3').textContent = `Rp ${user.denda.toLocaleString()}`;
        document.querySelector('.card-green p').innerHTML = `${user.jatuhTempo}<br><small>${user.hariJatuhTempo} hari lagi</small>`;
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }
    
    // Load popular books
    async function loadPopularBooks() {
      try {
        const response = await fetch(`${API_BASE}/books/popular`);
        const popularBooks = await response.json();
        
        // Load all books for global access
        const allBooksResponse = await fetch(`${API_BASE}/books`);
        books = await allBooksResponse.json();
        
        const booksContainer = document.querySelector('.popular-books');
        booksContainer.innerHTML = '';
        
        popularBooks.forEach(book => {
          const bookCard = document.createElement('div');
          bookCard.className = 'col-md-2';
          bookCard.innerHTML = `
            <div class="card">
              <img class="card-img-top" alt="${book.namaBuku}">
              <div class="card-body p-2 text-center">
                <small>${book.namaBuku}</small>
                <br><small class="text-muted">${book.penulis}</small>
                <br><small class="text-success">Stok: ${book.stok}</small>
              </div>
            </div>
          `;
          setBookImage(bookCard.querySelector('.card-img-top'), book);
          bookCard.querySelector('.card').addEventListener('click', () => openBookModal(book));
          booksContainer.appendChild(bookCard);
        });
      } catch (error) {
        console.error('Error loading popular books:', error);
      }
    }
    
    // Load all books
    async function loadAllBooks() {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      // Show loading state
      if (sectionTitle) {
        sectionTitle.textContent = 'Memuat Semua Buku...';
      }
      if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      }
      
      try {
        const response = await fetch(`${API_BASE}/books`);
        books = await response.json();
        displayAllBooks(books);
      } catch (error) {
        console.error('Error loading all books:', error);
        if (resultsContainer) {
          resultsContainer.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat data buku</div>';
        }
        if (sectionTitle) {
          sectionTitle.textContent = 'Semua Buku';
        }
      }
    }
    
    // Display all books
    function displayAllBooks(books) {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      if (!resultsContainer) return;
      
      // Update section title
      if (sectionTitle) {
        sectionTitle.textContent = `Semua Buku (${books.length} buku)`;
      }
      
      resultsContainer.innerHTML = '';
      
      if (books.length === 0) {
        resultsContainer.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-book-open me-2"></i>Tidak ada buku tersedia</div>';
        return;
      }
      
      books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'col-md-2 mb-3';
        bookCard.innerHTML = `
          <div class="card h-100">
            <img class="card-img-top" alt="${book.namaBuku}">
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-truncate" title="${book.namaBuku}">${book.namaBuku}</h6>
              <p class="card-text">
                <small class="text-muted d-block mb-1">
                  <i class="fas fa-user me-1"></i>${book.penulis}
                </small>
                <small class="text-info d-block mb-1">
                  <i class="fas fa-building me-1"></i>${book.penerbit}
                </small>
                <small class="text-secondary d-block mb-2">
                  <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                </small>
                <span class="badge ${book.stok > 0 ? 'bg-success' : 'bg-danger'}">
                  <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                </span>
              </p>
            </div>
            <div class="card-footer bg-transparent border-0 p-2">
              <small class="text-muted">
                <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
              </small>
            </div>
          </div>
        `;
        bookCard.querySelector('.card').addEventListener('click', () => openBookModal(book));
        setBookImage(bookCard.querySelector('.card-img-top'), book);
        resultsContainer.appendChild(bookCard);
      });
    }
    
    // Search functionality
    function setupSearch() {
      const searchInput = document.querySelector('#searchSemuaBuku input');
      const searchButton = document.querySelector('#searchSemuaBuku button');
      
      if (searchInput && searchButton) {
        searchButton.addEventListener('click', async () => {
          const query = searchInput.value.trim();
          if (query) {
            try {
              const response = await fetch(`${API_BASE}/books/search?q=${encodeURIComponent(query)}`);
              const books = await response.json();
              displayAllBooks(books);
            } catch (error) {
              console.error('Error searching books:', error);
            }
          } else {
            // If search is empty, show all books
            loadAllBooks();
          }
        });
        
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchButton.click();
          }
        });
      }
    }
    
    
    // Load available books
    async function loadAvailableBooks() {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      // Show loading state
      if (sectionTitle) {
        sectionTitle.textContent = 'Memuat Buku Tersedia...';
      }
      if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      }
      
      try {
        const response = await fetch(`${API_BASE}/books/available`);
        const availableBooks = await response.json();
        
        // Load all books for global access
        const allBooksResponse = await fetch(`${API_BASE}/books`);
        books = await allBooksResponse.json();
        
        displayAvailableBooks(availableBooks);
      } catch (error) {
        console.error('Error loading available books:', error);
        if (resultsContainer) {
          resultsContainer.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat data buku</div>';
        }
        if (sectionTitle) {
          sectionTitle.textContent = 'Buku Tersedia';
        }
      }
    }
    
    // Display available books
    function displayAvailableBooks(books) {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      if (!resultsContainer) return;
      
      // Update section title
      if (sectionTitle) {
        sectionTitle.textContent = `Buku Tersedia (${books.length} buku)`;
      }
      
      resultsContainer.innerHTML = '';
      
      if (books.length === 0) {
        resultsContainer.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-book-open me-2"></i>Tidak ada buku tersedia</div>';
        return;
      }
      
      books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'col-md-2 mb-3';
        bookCard.innerHTML = `
          <div class="card h-100">
            <img class="card-img-top" alt="${book.namaBuku}">
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-truncate" title="${book.namaBuku}">${book.namaBuku}</h6>
              <p class="card-text">
                <small class="text-muted d-block mb-1">
                  <i class="fas fa-user me-1"></i>${book.penulis}
                </small>
                <small class="text-info d-block mb-1">
                  <i class="fas fa-building me-1"></i>${book.penerbit}
                </small>
                <small class="text-secondary d-block mb-2">
                  <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                </small>
                <span class="badge bg-success">
                  <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                </span>
              </p>
            </div>
            <div class="card-footer bg-transparent border-0 p-2">
              <small class="text-muted">
                <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
              </small>
            </div>
          </div>
        `;
        bookCard.querySelector('.card').addEventListener('click', () => openBookModal(book));
        setBookImage(bookCard.querySelector('.card-img-top'), book);
        resultsContainer.appendChild(bookCard);
      });
    }
    
    // Show no latest books message
    function showNoLatestBooks() {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      if (!resultsContainer) return;
      
      // Update section title
      if (sectionTitle) {
        sectionTitle.textContent = 'Buku Terbaru';
      }
      
      resultsContainer.innerHTML = `
        <div class="col-12 text-center py-5">
          <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Belum Ada Buku Terbaru</h5>
          <p class="text-muted">Koleksi buku terbaru akan segera hadir. Silakan cek kembali nanti.</p>
        </div>
      `;
    }
    
    // Setup submenu click handlers
    function setupSubmenuHandlers() {
      // Semua Buku submenu
      const semuaBukuLink = document.querySelector('a[href="#searchSemuaBuku"]');
      if (semuaBukuLink) {
        semuaBukuLink.addEventListener('click', (e) => {
          e.preventDefault();
          // Show search bar
          const searchBar = document.getElementById('searchSemuaBuku');
          if (searchBar) {
            const bsCollapse = new bootstrap.Collapse(searchBar, { show: true });
          }
          // Load all books
          loadAllBooks();
        });
      }
      
      // Buku Tersedia submenu
      const allLinks = document.querySelectorAll('a[href="#"]');
      allLinks.forEach(link => {
        if (link.textContent.includes('Buku Tersedia')) {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            // Hide search bar
            const searchBar = document.getElementById('searchSemuaBuku');
            if (searchBar) {
              const bsCollapse = new bootstrap.Collapse(searchBar, { hide: true });
            }
            // Load available books
            loadAvailableBooks();
          });
        }
        
        if (link.textContent.includes('Buku Terbaru')) {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            // Hide search bar
            const searchBar = document.getElementById('searchSemuaBuku');
            if (searchBar) {
              const bsCollapse = new bootstrap.Collapse(searchBar, { hide: true });
            }
            // Show no latest books message
            showNoLatestBooks();
          });
        }
      });
    }
    
    // Function to open pinjam modal from book detail
    function openPinjamModal() {
      const bookModal = bootstrap.Modal.getInstance(document.getElementById('bookModal'));
      const pinjamModal = new bootstrap.Modal(document.getElementById('pinjamModal'));
      
      // Get book ID from current book detail
      const bookId = document.getElementById('bookTitle').textContent;
      const book = books.find(b => b.namaBuku === bookId);
      if (book) {
        document.getElementById('pinjamIdBuku').value = book.idBuku;
      }
      
      bookModal.hide();
      pinjamModal.show();
    }
    
    // Function to submit pinjam form
    async function submitPinjam() {
      const form = document.getElementById('pinjamForm');
      const messageDiv = document.getElementById('pinjamMessage');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Clear previous message
      messageDiv.innerHTML = '';
      
      try {
        const response = await fetch(`${API_BASE}/loans`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
          form.reset();
          // Refresh user data and books
          loadUserData();
          loadPopularBooks();
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${error.message}</div>`;
      }
    }
    
    // Function to submit pengembalian form
    async function submitPengembalian() {
      const form = document.getElementById('pengembalianForm');
      const messageDiv = document.getElementById('pengembalianMessage');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Clear previous message
      messageDiv.innerHTML = '';
      
      try {
        const response = await fetch(`${API_BASE}/returns`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
          if (result.return.denda > 0) {
            messageDiv.innerHTML += `<div class="alert alert-warning">Denda: Rp ${result.return.denda.toLocaleString()}</div>`;
          }
          form.reset();
          // Refresh user data and books
          loadUserData();
          loadPopularBooks();
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${error.message}</div>`;
      }
    }
    
    // Function to load loan status
    async function loadLoanStatus() {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      // Show loading state
      if (sectionTitle) {
        sectionTitle.textContent = 'Memuat Status Peminjaman...';
      }
      if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      }
      
      try {
        const response = await fetch(`${API_BASE}/loans`);
        const loans = await response.json();
        
        if (sectionTitle) {
          sectionTitle.textContent = `Status Peminjaman (${loans.length} aktif)`;
        }
        
        if (resultsContainer) {
          resultsContainer.innerHTML = '';
          
          if (loans.length === 0) {
            resultsContainer.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-book-open me-2"></i>Tidak ada peminjaman aktif</div>';
            return;
          }
          
          const listGroup = document.createElement('div');
          listGroup.className = 'list-group';
          
          loans.forEach(loan => {
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            const book = books.find(b => b.idBuku === loan.idBuku);
            const bookName = book ? book.namaBuku : 'Buku tidak ditemukan';
            
            listItem.innerHTML = `
              <div>
                <h6 class="mb-1">${bookName}</h6>
                <small class="text-muted">ID: ${loan.idBuku} | Peminjam: ${loan.nama}</small>
                <br>
                <small class="text-info">Pinjam: ${loan.tanggalPinjam} | Jatuh tempo: ${loan.tanggalKembali}</small>
              </div>
              <span class="badge ${loan.terlambat ? 'bg-danger' : 'bg-success'}">
                ${loan.terlambat ? 'Terlambat' : 'On-time'}
              </span>
            `;
            
            listGroup.appendChild(listItem);
          });
          
          resultsContainer.appendChild(listGroup);
        }
      } catch (error) {
        console.error('Error loading loan status:', error);
        if (resultsContainer) {
          resultsContainer.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat status peminjaman</div>';
        }
        if (sectionTitle) {
          sectionTitle.textContent = 'Status Peminjaman';
        }
      }
    }
    
    // Function to load loan history
    async function loadLoanHistory() {
      const resultsContainer = document.querySelector('.popular-books');
      const sectionTitle = document.getElementById('sectionTitle');
      
      // Show loading state
      if (sectionTitle) {
        sectionTitle.textContent = 'Memuat Riwayat Peminjaman...';
      }
      if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      }
      
      try {
        const response = await fetch(`${API_BASE}/returns`);
        const returns = await response.json();
        
        if (sectionTitle) {
          sectionTitle.textContent = `Riwayat Peminjaman (${returns.length} selesai)`;
        }
        
        if (resultsContainer) {
          resultsContainer.innerHTML = '';
          
          if (returns.length === 0) {
            resultsContainer.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-history me-2"></i>Belum ada riwayat peminjaman</div>';
            return;
          }
          
          const listGroup = document.createElement('div');
          listGroup.className = 'list-group';
          
          returns.forEach(returnItem => {
            const listItem = document.createElement('div');
            listItem.className = 'list-group-item';
            
            const book = books.find(b => b.idBuku === returnItem.idBuku);
            const bookName = book ? book.namaBuku : 'Buku tidak ditemukan';
            
            listItem.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${bookName}</h6>
                  <small class="text-muted">ID: ${returnItem.idBuku} | Peminjam: ${returnItem.nama}</small>
                  <br>
                  <small class="text-info">Pinjam: ${returnItem.tanggalPinjam} | Kembali: ${returnItem.tanggalPengembalian}</small>
                </div>
                <div class="text-end">
                  <span class="badge ${returnItem.denda > 0 ? 'bg-warning' : 'bg-success'}">
                    ${returnItem.denda > 0 ? `Denda: Rp ${returnItem.denda.toLocaleString()}` : 'Tepat Waktu'}
                  </span>
                </div>
              </div>
            `;
            
            listGroup.appendChild(listItem);
          });
          
          resultsContainer.appendChild(listGroup);
        }
      } catch (error) {
        console.error('Error loading loan history:', error);
        if (resultsContainer) {
          resultsContainer.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat riwayat peminjaman</div>';
        }
        if (sectionTitle) {
          sectionTitle.textContent = 'Riwayat Peminjaman';
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      loadUserData();
      loadPopularBooks();
      setupSearch();
      setupSubmenuHandlers();
    });
  </script>
</body>
</html>



