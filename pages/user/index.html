<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>NesPus - Main Menu User</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f5f6fa;
      }
      .sidebar {
        height: 100vh;
        background: #1e3d59;
        color: #fff;
        padding: 20px 10px;
        position: fixed;
        width: 220px;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .sidebar a:hover {
        background: #3a506b;
      }
      .content {
        margin-left: 240px;
        padding: 20px;
      }
      .card-info {
        border-radius: 12px;
        padding: 20px;
        color: #fff;
      }
      .card-blue {
        background: #007bff;
      }
      .card-orange {
        background: #ff8c42;
      }
      .card-green {
        background: #4caf50;
      }
      .hero {
        background: linear-gradient(
            135deg,
            rgba(30, 61, 89, 0.85),
            rgba(0, 123, 255, 0.75)
          ),
          url("https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop")
            center/cover no-repeat;
        border-radius: 16px;
        color: #fff;
        padding: 28px;
        min-height: 160px;
        display: flex;
        align-items: center;
      }
      .hero h4 {
        margin: 0 0 6px 0;
      }
      .hero p {
        margin: 0;
        opacity: 0.95;
      }
      .popular-books {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .popular-books > div {
        flex: 0 1 calc(20% - 12px);
        min-width: 120px;
      }
      .popular-books .card {
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      .popular-books .card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .popular-books .card-img-top {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
      }
      .popular-books .card-body {
        padding: 8px;
      }
      .popular-books .card-body small {
        font-size: 0.75rem;
        display: block;
        text-align: center;
      }
      @media (max-width: 1200px) {
        .popular-books > div {
          flex: 0 1 calc(25% - 12px);
        }
      }
      @media (max-width: 768px) {
        .popular-books > div {
          flex: 0 1 calc(33.333% - 12px);
        }
      }
      @media (max-width: 576px) {
        .popular-books > div {
          flex: 0 1 calc(50% - 12px);
        }
      }
      .site-logo {
        height: 120px;
        display: block;
      }
      .site-brand {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .site-name {
        margin-top: 8px;
        font-size: 1.6rem;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        text-align: center;
        line-height: 1;
      }

      /* Mobile topbar and sidebar overlay */
      .mobile-topbar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: #1e3d59;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        z-index: 2000;
      }
      .mobile-topbar .menu-btn {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 22px;
      }
      .mobile-topbar .mobile-brand {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #fff;
      }
      .site-logo-mobile {
        height: 36px;
        display: block;
      }
      .site-name-mobile {
        font-weight: 700;
        letter-spacing: 0.6px;
        text-transform: uppercase;
      }

      .sidebar-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar {
        transition: transform 0.25s ease;
      }
      .no-scroll {
        overflow: hidden;
      }

      @media (max-width: 767.98px) {
        .mobile-topbar {
          display: flex;
        }
        .sidebar {
          transform: translateX(-100%);
          position: fixed;
          z-index: 2001;
          width: 220px;
          height: 100vh;
          top: 0;
          left: 0;
        }
        .content {
          margin-left: 0;
          padding-top: 76px;
        }
        .sidebar h4 {
          padding-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile topbar (visible on small screens) -->
    <div class="mobile-topbar d-md-none">
      <button
        class="menu-btn"
        id="mobileMenuBtn"
        aria-label="Toggle menu"
        onclick="toggleMobileMenu()"
      >
        ☰
      </button>
      <div class="mobile-brand">
        <img
          src="/images/school_logo.png"
          alt="logo"
          class="site-logo-mobile"
        /><span class="site-name-mobile">NesPus</span>
      </div>
      <div style="width: 32px"></div>
    </div>
    <!-- Sidebar -->
    <div class="sidebar">
      <h4 class="text-center mb-4">
        <div class="site-brand">
          <img src="/images/school_logo.png" alt="logo" class="site-logo" />
          <div class="site-name">NesPus</div>
        </div>
      </h4>
      <h6 class="text-center mb-3 text-warning">User Panel</h6>

      <a href="#" id="homeLink"> <i class="fas fa-home me-2"></i>Home </a>
      <a href="#" onclick="showAllBooks()">
        <i class="fas fa-book me-2"></i>Semua Buku
      </a>
      <a href="#" onclick="loadLoanStatus()">
        <i class="fas fa-chart-bar me-2"></i>Status Peminjaman
      </a>
      <a href="#" onclick="loadLoanHistory()">
        <i class="fas fa-history me-2"></i>Riwayat Peminjaman
      </a>
      <hr class="my-3" />
      <a
        href="#"
        class="text-danger fw-bold"
        data-bs-toggle="modal"
        data-bs-target="#logoutModal"
      >
        <i class="fas fa-sign-out-alt me-2"></i>Logout
      </a>
    </div>

    <div
      id="sidebarBackdrop"
      class="sidebar-backdrop"
      onclick="toggleMobileMenu()"
    ></div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Halo, <span id="greetingName">Andiva</span> 👋</h3>
        <div class="dropdown">
          <button
            class="btn btn-outline-secondary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            👤 Andiva
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" onclick="openUserProfile(event)"
                >Profile User</a
              >
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-danger"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#logoutModal"
                >Logout</a
              >
            </li>
          </ul>
        </div>
      </div>

      <div class="hero mb-4">
        <div>
          <h4>Selamat datang di NesPus</h4>
          <p>Temukan inspirasi dari ribuan koleksi buku digital kami.</p>
        </div>
      </div>

      <!-- Tentang Perpustakaan -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-2">Tentang NesPus</h5>
          <p class="card-text mb-2">
            Selamat datang di NesPus, perpustakaan digital yang membantu Anda
            menemukan, meminjam, dan mengembalikan buku dengan mudah. Nikmati
            kemudahan akses koleksi kami kapan saja dan di mana saja.
          </p>
          <ul class="mb-0">
            <li>Akses cepat ke semua koleksi dan buku terbaru</li>
            <li>Peminjaman online dengan status peminjaman yang jelas</li>
            <li>Notifikasi jatuh tempo terkini</li>
          </ul>
        </div>
      </div>

      <!-- Dashboard Info -->
      <div class="row mb-4" id="dashboardCards">
        <div class="col-md-6">
          <div class="card-info card-blue">
            <h6>Buku Dipinjam</h6>
            <h3>2</h3>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card-info card-green">
            <h6>Jatuh Tempo Terdekat</h6>
            <p>—</p>
          </div>
        </div>
      </div>

      <!-- Buku Section -->
      <div class="popular-books">
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/8231856-L.jpg"
              class="card-img-top"
              alt="Atomic Habits"
            />
            <div class="card-body p-2 text-center">
              <small>Atomic Habits</small>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/9259251-L.jpg"
              class="card-img-top"
              alt="The Midnight Library"
            />
            <div class="card-body p-2 text-center">
              <small>The Midnight Library</small>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/11153284-L.jpg"
              class="card-img-top"
              alt="sapiens"
            />
            <div class="card-body p-2 text-center">
              <small>Sapiens</small>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/10909258-L.jpg"
              class="card-img-top"
              alt="Becoming"
            />
            <div class="card-body p-2 text-center">
              <small>Becoming</small>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/12880737-L.jpg"
              class="card-img-top"
              alt="Educated"
            />
            <div class="card-body p-2 text-center">
              <small>Educated</small>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <img
              src="https://covers.openlibrary.org/b/id/12604065-L.jpg"
              class="card-img-top"
              alt="The Alchemist"
            />
            <div class="card-body p-2 text-center">
              <small>The Alchemist</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Konfirmasi Logout</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Apakah Anda serius mau logout?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Tidak
            </button>
            <a
              href="/"
              class="btn btn-danger"
              onclick="try{
                // Clear only session data (username and userid), keep profile picture
                localStorage.removeItem('username');
                localStorage.removeItem('userid');
              }catch(e){}"
              >Ya, Logout</a
            >
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bookModalTitle">Detail Buku</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-5">
                <img
                  id="bookCoverImg"
                  src=""
                  alt="Book Cover"
                  class="img-fluid rounded"
                  style="
                    width: 100%;
                    max-width: 200px;
                    max-height: 300px;
                    object-fit: contain;
                    display: block;
                    margin: 0 auto;
                  "
                />
              </div>
              <div class="col-md-7">
                <h5 id="bookTitle" class="mb-2"></h5>
                <p class="mb-2">
                  <small class="text-muted" id="bookAuthor"></small>
                </p>
                <p
                  id="bookSynopsis"
                  class="mb-3 text-justify"
                  style="font-size: 0.95rem; line-height: 1.5"
                ></p>
                <div class="small text-secondary" style="line-height: 1.8">
                  <div>
                    <strong>Penerbit:</strong> <span id="bookPublisher"></span>
                  </div>
                  <div><strong>Tahun:</strong> <span id="bookYear"></span></div>
                  <div><strong>ID Buku:</strong> <span id="bookId"></span></div>
                  <div><strong>Stok:</strong> <span id="bookStock"></span></div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Populate greeting from login
      (function () {
        const name = localStorage.getItem("username");
        if (name) {
          const el = document.getElementById("greetingName");
          if (el) el.textContent = name;
        }
      })();
    </script>
    <!-- User Profile Offcanvas -->
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="userProfileOffcanvas"
      aria-labelledby="userProfileLabel"
    >
      <div class="offcanvas-header">
        <script>
          // Mobile menu toggle
          function toggleMobileMenu() {
            const sidebar = document.querySelector(".sidebar");
            const backdrop = document.getElementById("sidebarBackdrop");
            if (!sidebar || !backdrop) return;
            const open = sidebar.classList.toggle("open");
            backdrop.classList.toggle("show", open);
            document.body.classList.toggle("no-scroll", open);
          }

          // Close mobile menu when a sidebar link is clicked
          document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".sidebar a").forEach((a) => {
              a.addEventListener("click", function () {
                if (window.innerWidth <= 768) {
                  const sidebar = document.querySelector(".sidebar");
                  const backdrop = document.getElementById("sidebarBackdrop");
                  if (sidebar && sidebar.classList.contains("open")) {
                    sidebar.classList.remove("open");
                    backdrop.classList.remove("show");
                    document.body.classList.remove("no-scroll");
                  }
                }
              });
            });
          });
        </script>
        <h5 id="userProfileLabel">Profile User</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <style>
          .profile-container {
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            text-align: center;
            color: white;
            margin-bottom: 30px;
          }
          .profile-avatar-large {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4e73df, #1cc88a);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            font-weight: 700;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            object-fit: cover;
            margin: 0 auto 20px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
          }
          .profile-avatar-large:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
          }
          #profilePictureInput {
            display: none;
          }
          .profile-info {
            margin-bottom: 15px;
          }
          .profile-info h2 {
            margin: 10px 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
          }
          .profile-info small {
            font-size: 14px;
            opacity: 0.9;
            display: block;
            margin: 5px 0;
          }
          .profile-info code {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            letter-spacing: 1px;
            display: inline-block;
            margin-top: 5px;
          }
          /* Make NIS digits white and bold for visibility */
          #viewNIS {
            color: #ffffff;
            font-weight: 700;
          }
          .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
          }
          .stat-item {
            text-align: center;
          }
          .stat-item h5 {
            font-size: 24px;
            margin: 0;
            font-weight: 700;
          }
          .stat-item p {
            font-size: 12px;
            margin: 5px 0 0 0;
            opacity: 0.85;
          }
          .edit-profile-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
          }
          .form-group-custom {
            margin-bottom: 18px;
          }
          .form-group-custom label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3d59;
            font-size: 14px;
          }
          .form-group-custom input,
          .form-group-custom textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
          }
          .form-group-custom input:focus,
          .form-group-custom textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          }
          .form-group-custom input:disabled {
            background: #f0f0f0;
            color: #666;
          }
          .upload-button {
            position: relative;
            display: inline-block;
            margin-top: 15px;
          }
          .upload-button label {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: background 0.3s ease;
            margin: 0;
            font-weight: 600;
          }
          .upload-button label:hover {
            background: #5568d3;
          }
          .btn-group-custom {
            display: flex;
            gap: 10px;
            margin-top: 25px;
          }
          .btn-group-custom button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
          }
          .btn-save {
            background: #667eea;
            color: white;
          }
          .btn-save:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          }
          .btn-cancel {
            background: #e0e0e0;
            color: #333;
          }
          .btn-cancel:hover {
            background: #d0d0d0;
          }
        </style>
        <ul class="nav nav-tabs mb-3" id="profileTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="view-tab"
              data-bs-toggle="tab"
              data-bs-target="#viewProfileTab"
              type="button"
              role="tab"
            >
              Lihat Profil
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="edit-tab"
              data-bs-toggle="tab"
              data-bs-target="#editProfileTab"
              type="button"
              role="tab"
            >
              Edit Profil
            </button>
          </li>
        </ul>
        <div class="tab-content">
          <div
            class="tab-pane fade show active"
            id="viewProfileTab"
            role="tabpanel"
          >
            <div class="profile-container">
              <div class="profile-avatar-large" id="profileAvatar">A</div>
              <div class="profile-info">
                <h2 id="viewName">-</h2>
                <small
                  id="viewRole"
                  style="
                    font-size: 13px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    opacity: 0.8;
                  "
                  >User</small
                >
              </div>
              <div class="profile-info">
                <small style="font-size: 12px">NIS:</small>
                <code id="viewNIS">-</code>
              </div>
              <div class="profile-info">
                <small style="font-size: 12px">Username:</small>
                <small
                  style="font-size: 15px; font-weight: 600"
                  id="viewUsername"
                  >-</small
                >
              </div>
              <div class="profile-info">
                <small style="font-size: 12px">Email:</small>
                <small style="font-size: 15px" id="viewEmail">-</small>
                <small style="font-size: 12px; display: block; margin-top: 6px"
                  >Telepon:</small
                >
                <small style="font-size: 15px" id="viewPhone">-</small>
              </div>
              <div class="profile-stats">
                <div class="stat-item">
                  <h5 id="viewLoanCount">0</h5>
                  <p>Buku Dipinjam</p>
                </div>
                <div class="stat-item">
                  <h5 id="viewGender">-</h5>
                  <p>Gender</p>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="editProfileTab" role="tabpanel">
            <div id="editProfileMsg"></div>

            <div class="text-center mb-4">
              <div class="upload-button">
                <div
                  class="profile-avatar-large"
                  id="editProfileAvatar"
                  style="cursor: pointer; margin-bottom: 15px"
                >
                  A
                </div>
                <label for="profilePictureInput">
                  <i class="fas fa-camera me-2"></i>Ubah Foto Profil
                </label>
                <input type="file" id="profilePictureInput" accept="image/*" />
              </div>
            </div>

            <div class="edit-profile-form">
              <form id="editProfileForm">
                <div class="form-group-custom">
                  <label for="editFullName">Nama Lengkap</label>
                  <input
                    type="text"
                    id="editFullName"
                    placeholder="Masukkan nama lengkap Anda"
                  />
                </div>

                <div class="form-group-custom">
                  <label for="viewNISEdit">NIS (Tidak dapat diubah)</label>
                  <input type="text" id="viewNISEdit" readonly disabled />
                </div>

                <div class="form-group-custom">
                  <label for="editUsername">Username</label>
                  <input
                    type="text"
                    id="editUsername"
                    placeholder="Masukkan username baru"
                  />
                </div>

                <div class="form-group-custom">
                  <label for="editEmail">Email</label>
                  <input
                    type="email"
                    id="editEmail"
                    placeholder="Masukkan email baru"
                  />
                </div>

                <div class="form-group-custom">
                  <label for="editPhone">Nomor Telepon</label>
                  <input
                    type="text"
                    id="editPhone"
                    placeholder="Masukkan nomor telepon"
                  />
                </div>

                <div class="form-group-custom">
                  <label for="editGender">Gender</label>
                  <select
                    id="editGender"
                    style="
                      width: 100%;
                      padding: 12px 15px;
                      border: 2px solid #e0e0e0;
                      border-radius: 8px;
                      font-size: 14px;
                    "
                  >
                    <option value="">Pilih Gender</option>
                    <option value="Pria">Pria</option>
                    <option value="Wanita">Wanita</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>

                <hr
                  style="
                    margin: 25px 0;
                    border: none;
                    border-top: 2px solid #e0e0e0;
                  "
                />

                <div class="form-group-custom">
                  <label for="editPassword"
                    >Password Baru (kosongkan jika tidak diubah)</label
                  >
                  <input
                    type="password"
                    id="editPassword"
                    placeholder="Masukkan password baru"
                  />
                </div>

                <div class="form-group-custom">
                  <label for="editPasswordConfirm">Konfirmasi Password</label>
                  <input
                    type="password"
                    id="editPasswordConfirm"
                    placeholder="Konfirmasi password baru"
                  />
                </div>

                <div class="btn-group-custom">
                  <button type="button" class="btn-save" id="saveProfileBtn">
                    <i class="fas fa-save me-2"></i>Simpan Perubahan
                  </button>
                  <button
                    type="button"
                    class="btn-cancel"
                    data-bs-toggle="tab"
                    data-bs-target="#viewProfileTab"
                  >
                    <i class="fas fa-arrow-left me-2"></i>Kembali
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Open the user profile offcanvas and load data
      function openUserProfile(e) {
        if (e) e.preventDefault();
        const off = new bootstrap.Offcanvas(
          document.getElementById("userProfileOffcanvas")
        );
        off.show();
        loadUserProfile();
      }

      async function loadUserProfile() {
        const userId = localStorage.getItem("userid");
        const username = localStorage.getItem("username") || null;

        console.log("loadUserProfile - userId:", userId, "username:", username);

        // Set default placeholders
        document.getElementById("viewName").textContent = "-";
        document.getElementById("viewNIS").textContent = "-";
        document.getElementById("viewUsername").textContent = username || "-";
        document.getElementById("viewRole").textContent = "-";
        document.getElementById("viewEmail").textContent = "-";
        document.getElementById("viewGender").textContent = "-";
        document.getElementById("viewPhone").textContent = "-";
        document.getElementById("viewLoanCount").textContent = "0";

        if (document.getElementById("editFullName"))
          document.getElementById("editFullName").value = "";
        if (document.getElementById("editUsername"))
          document.getElementById("editUsername").value = "";
        if (document.getElementById("viewNISEdit"))
          document.getElementById("viewNISEdit").value = "";
        if (document.getElementById("editEmail"))
          document.getElementById("editEmail").value = "";
        if (document.getElementById("editPhone"))
          document.getElementById("editPhone").value = "";
        if (document.getElementById("editGender"))
          document.getElementById("editGender").value = "";

        try {
          let user = null;

          // Try API endpoint first
          if (userId) {
            try {
              console.log("Trying to fetch /profile/" + userId);
              const r = await fetch(`/profile/${userId}`);
              console.log("Response status:", r.status);
              if (r.ok) {
                user = await r.json();
                console.log("Loaded user from /profile/:userId:", user);
              }
            } catch (e) {
              console.log("Failed to load from /profile/:userId", e);
            }
          }

          if (user) {
            const displayName =
              user.fullName || user.nama || user.name || user.username || "-";
            document.getElementById("viewName").textContent = displayName;
            document.getElementById("viewNIS").textContent = user.nis || "-";
            document.getElementById("viewUsername").textContent =
              user.username || "-";
            document.getElementById("viewRole").textContent = (
              user.role ||
              (user.isAdmin ? "admin" : "user") ||
              "-"
            ).toString();
            document.getElementById("viewEmail").textContent =
              user.email || "-";
            document.getElementById("viewGender").textContent =
              user.gender || "-";
            document.getElementById("viewPhone").textContent =
              user.phone || "-";
            if (document.getElementById("editFullName"))
              document.getElementById("editFullName").value =
                user.fullName || "";
            if (document.getElementById("editUsername"))
              document.getElementById("editUsername").value =
                user.username || user.nama || "";
            if (document.getElementById("viewNISEdit"))
              document.getElementById("viewNISEdit").value = user.nis || "-";
            if (document.getElementById("editEmail"))
              document.getElementById("editEmail").value = user.email || "";
            if (document.getElementById("editPhone"))
              document.getElementById("editPhone").value = user.phone || "";
            if (document.getElementById("editGender"))
              document.getElementById("editGender").value = user.gender || "";

            // Avatar: initials and color or profile picture (prefer local storage copy)
            try {
              const avatarEl = document.getElementById("profileAvatar");
              const editAvatarEl = document.getElementById("editProfileAvatar");
              const localPicKey = userId ? `profile_pic_${userId}` : null;
              const localPic = localPicKey
                ? localStorage.getItem(localPicKey) || null
                : null;
              // Prioritize server picture, then local storage
              const picToUse = user.profilePicture || localPic || null;

              // Save server picture to localStorage if available
              if (user.profilePicture && userId) {
                try {
                  localStorage.setItem(
                    `profile_pic_${userId}`,
                    user.profilePicture
                  );
                } catch (e) {
                  console.warn(
                    "Could not save profile picture to localStorage:",
                    e
                  );
                }
              }

              if (picToUse) {
                // If we have a picture (local or from server), display it as image
                if (avatarEl) {
                  avatarEl.textContent = "";
                  avatarEl.style.backgroundImage = `url(${picToUse})`;
                  avatarEl.style.backgroundSize = "cover";
                  avatarEl.style.backgroundPosition = "center";
                }
                if (editAvatarEl) {
                  editAvatarEl.textContent = "";
                  editAvatarEl.style.backgroundImage = `url(${picToUse})`;
                  editAvatarEl.style.backgroundSize = "cover";
                  editAvatarEl.style.backgroundPosition = "center";
                }
              } else {
                // Display initials
                let initials = (displayName || "")
                  .split(" ")
                  .filter(Boolean)
                  .slice(0, 2)
                  .map((s) => s[0].toUpperCase())
                  .join("");
                if (!initials)
                  initials = (user.username || "U")
                    .substring(0, 2)
                    .toUpperCase();

                const palette = [
                  "linear-gradient(135deg,#4e73df,#1cc88a)",
                  "linear-gradient(135deg,#f6c23e,#e74a3b)",
                  "linear-gradient(135deg,#36b9cc,#4e73df)",
                  "linear-gradient(135deg,#6f42c1,#e83e8c)",
                ];
                // pick stable color
                let sum = 0;
                for (let i = 0; i < displayName.length; i++)
                  sum += displayName.charCodeAt(i);
                const bgColor = palette[sum % palette.length];

                if (avatarEl) {
                  avatarEl.textContent = initials;
                  avatarEl.style.background = bgColor;
                }
                if (editAvatarEl) {
                  editAvatarEl.textContent = initials;
                  editAvatarEl.style.background = bgColor;
                }
              }
            } catch (e) {}
          }

          // Count active loans for this user via API
          if (userId) {
            try {
              const r = await fetch("/api/loans");
              if (r.ok) {
                const loans = await r.json();
                const active = loans.filter(
                  (l) =>
                    String(l.idUser) === String(userId) &&
                    (l.status === "aktif" ||
                      l.status === "ongoing" ||
                      l.status === "dipinjam")
                );
                document.getElementById("viewLoanCount").textContent =
                  active.length;
              }
            } catch (e) {
              /* ignore */
            }
          }
        } catch (err) {
          console.error("Failed to load user profile", err);
        }
      }

      document
        .getElementById("saveProfileBtn")
        ?.addEventListener("click", async function () {
          const fullName = document
            .getElementById("editFullName")
            ?.value?.trim();
          const username = document
            .getElementById("editUsername")
            ?.value?.trim();
          const email = document.getElementById("editEmail")?.value?.trim();
          const phone = document.getElementById("editPhone")?.value?.trim();
          const gender = document.getElementById("editGender")?.value?.trim();
          const pwd = document.getElementById("editPassword")?.value || "";
          const pwd2 =
            document.getElementById("editPasswordConfirm")?.value || "";
          const userId = localStorage.getItem("userid");
          const currentUsername = localStorage.getItem("username");
          const msgEl = document.getElementById("editProfileMsg");
          msgEl.innerHTML = "";
          if (!currentUsername && !userId) {
            msgEl.innerHTML =
              '<div class="alert alert-danger">Tidak terdeteksi user login</div>';
            return;
          }
          if (pwd && pwd !== pwd2) {
            msgEl.innerHTML =
              '<div class="alert alert-danger">Konfirmasi password tidak sesuai</div>';
            return;
          }
          // Try to send update to API if available
          let updated = false;
          if (userId) {
            try {
              const body = {};
              if (fullName) body.fullName = fullName;
              if (username) body.username = username;
              if (email) body.email = email;
              if (phone) body.phone = phone;
              if (gender) body.gender = gender;
              if (pwd) body.password = pwd;
              const r = await fetch(`/profile/${userId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              });
              if (r.ok) {
                updated = true;
              }
            } catch (e) {
              // ignore and fallback
            }
          }
          // Fallback: update localStorage display and inform user
          if (!updated) {
            if (fullName)
              try {
                localStorage.setItem("fullName", fullName);
              } catch (e) {}
            if (username)
              try {
                localStorage.setItem("username", username);
              } catch (e) {}
            msgEl.innerHTML =
              '<div class="alert alert-success">Perubahan disimpan (lokal). Jika backend tersedia, perubahan akan disinkronkan.</div>';
          } else {
            msgEl.innerHTML =
              '<div class="alert alert-success">Perubahan berhasil disimpan ke server.</div>';
          }
          // refresh view
          loadUserProfile();
          // clear password field
          document.getElementById("editPassword").value = "";
          document.getElementById("editPasswordConfirm").value = "";
        });

      // Handle profile picture upload
      document
        .getElementById("profilePictureInput")
        ?.addEventListener("change", async function (e) {
          const file = e.target.files?.[0];
          if (!file) return;

          // Validate file is image
          if (!file.type.startsWith("image/")) {
            alert("Silakan pilih file gambar");
            return;
          }

          // Validate file size (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert("Ukuran file maksimal 2MB");
            return;
          }

          const reader = new FileReader();
          reader.onload = async function (event) {
            const base64Image = event.target.result;
            const userId = localStorage.getItem("userid");
            const username = localStorage.getItem("username");

            // Save to localStorage (local fallback)
            if (userId) {
              try {
                localStorage.setItem(`profile_pic_${userId}`, base64Image);
              } catch (e) {
                console.warn("Could not save to localStorage:", e);
              }
            }

            // Try to send to API
            if (userId) {
              try {
                const r = await fetch(`/profile/${userId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ profilePicture: base64Image }),
                });
                if (!r.ok) {
                  console.warn("Failed to upload profile picture to server");
                }
              } catch (e) {
                console.warn("Could not upload to server:", e);
              }
            }

            // Update avatar immediately (in both view and edit tabs)
            const profileAvatarEl = document.getElementById("profileAvatar");
            if (profileAvatarEl) {
              profileAvatarEl.textContent = "";
              profileAvatarEl.style.backgroundImage = `url(${base64Image})`;
              profileAvatarEl.style.backgroundSize = "cover";
              profileAvatarEl.style.backgroundPosition = "center";
            }

            const editAvatarEl = document.getElementById("editProfileAvatar");
            if (editAvatarEl) {
              editAvatarEl.textContent = "";
              editAvatarEl.style.backgroundImage = `url(${base64Image})`;
              editAvatarEl.style.backgroundSize = "cover";
              editAvatarEl.style.backgroundPosition = "center";
            }

            // Reset input and blur to ensure the same file can be selected again
            e.target.value = "";
            try {
              e.target.blur();
            } catch (err) {}
            setTimeout(() => {
              try {
                e.target.value = "";
              } catch (_) {}
            }, 50);
          };
          reader.readAsDataURL(file);
        });
    </script>
    <script>
      // Live update when account switches in another tab/window
      window.addEventListener("storage", (e) => {
        console.log("Storage event detected:", e.key);
        if (
          e.key === "username" ||
          e.key === "userid" ||
          e.key === "books:updated" ||
          e.key === "loans:updated" ||
          e.key === "returns:updated"
        ) {
          console.log("Triggering live update for:", e.key);
          try {
            loadUserData();
            // reload current section data best-effort
            const sectionTitle =
              document.getElementById("sectionTitle")?.textContent || "";
            if (sectionTitle.includes("Populer")) {
              loadPopularBooks();
            } else if (sectionTitle.includes("Semua Buku")) {
              loadAllBooks();
            } else if (sectionTitle.includes("Buku Tersedia")) {
              loadAvailableBooks();
            } else if (sectionTitle.includes("Buku Terbaru")) {
              loadLatestBooks();
            } else if (sectionTitle.includes("Status Peminjaman")) {
              // Refresh loan status if currently viewing it
              if (typeof window.loadLoanStatus === "function")
                window.loadLoanStatus();
            } else if (sectionTitle.includes("Riwayat Peminjaman")) {
              // Refresh loan history if currently viewing it
              if (typeof window.loadHistory === "function")
                window.loadHistory();
            }
            // keep top cards updated
            refreshDashboardCardsLive();
          } catch (err) {
            console.error("Error in live update:", err);
          }
        }
      });

      // Same-tab live updates (polling mechanism)
      let lastLoansUpdate = localStorage.getItem("loans:updated") || "0";
      let lastReturnsUpdate = localStorage.getItem("returns:updated") || "0";

      setInterval(() => {
        const currentLoansUpdate = localStorage.getItem("loans:updated") || "0";
        const currentReturnsUpdate =
          localStorage.getItem("returns:updated") || "0";

        if (
          currentLoansUpdate !== lastLoansUpdate ||
          currentReturnsUpdate !== lastReturnsUpdate
        ) {
          console.log(
            "Polling detected update - loans:",
            currentLoansUpdate,
            "returns:",
            currentReturnsUpdate
          );
          lastLoansUpdate = currentLoansUpdate;
          lastReturnsUpdate = currentReturnsUpdate;

          try {
            // Always refresh user data first
            loadUserData();

            // Check what section is currently active and refresh accordingly
            const sectionTitle =
              document.getElementById("sectionTitle")?.textContent || "";
            console.log("Current section title:", sectionTitle);

            if (sectionTitle.includes("Status Peminjaman")) {
              console.log("Refreshing loan status...");
              if (typeof window.loadLoanStatus === "function") {
                window.loadLoanStatus();
              } else {
                console.error("loadLoanStatus function not found");
              }
            } else if (sectionTitle.includes("Riwayat Peminjaman")) {
              console.log("Refreshing loan history...");
              if (typeof window.loadHistory === "function") {
                window.loadHistory();
              } else {
                console.error("loadHistory function not found");
              }
            }

            // Always refresh dashboard cards
            refreshDashboardCardsLive();
          } catch (err) {
            console.error("Error in polling update:", err);
          }
        }
      }, 500); // Check every 500ms for faster response
    </script>
    <script>
      // Same-tab live session detection (no manual refresh)
      (function () {
        let lastUid = localStorage.getItem("userid");
        let lastUname = localStorage.getItem("username");
        setInterval(() => {
          const uid = localStorage.getItem("userid");
          const uname = localStorage.getItem("username");
          if (uid !== lastUid || uname !== lastUname) {
            lastUid = uid;
            lastUname = uname;
            try {
              loadUserData();
              const sectionTitle =
                document.getElementById("sectionTitle")?.textContent || "";
              if (sectionTitle.includes("Populer")) {
                loadPopularBooks();
              } else if (sectionTitle.includes("Semua Buku")) {
                loadAllBooks();
              } else if (sectionTitle.includes("Buku Tersedia")) {
                loadAvailableBooks();
              } else if (sectionTitle.includes("Buku Terbaru")) {
                loadLatestBooks();
              }
              if (typeof window.loadLoanStatus === "function")
                window.loadLoanStatus();
            } catch (_) {}
          }
        }, 1000);
      })();
    </script>
    <script>
      // API Base URL (dynamic): use current origin if available, fallback to localhost
      const API_BASE = (function () {
        try {
          if (
            typeof window !== "undefined" &&
            window.location &&
            /^https?:/.test(window.location.origin)
          ) {
            return window.location.origin.replace(/\/$/, "") + "/api";
          }
        } catch (_) {}
        return "http://localhost:3001/api";
      })();

      // Global books array
      let books = [];

      // Global cache for all books
      let allBooksCache = [];

      // Current category filter
      let currentCategory = "semua";

      // Global system settings
      let systemSettings = {
        libraryName: "NesPus",
        maxLoanDays: 7,
        finePerDay: 1000,
        maxBooksPerUser: 5,
        autoRenewal: "disabled",
        notificationDays: 2,
      };

      // Global function to render books with sort and search
      function renderBooksWithSortAndSearch() {
        const semuaBukuList = document.getElementById("semuaBukuList");
        const searchBukuInput = document.getElementById("searchBukuInput");
        const sortBuku = document.getElementById("sortBuku");

        if (!semuaBukuList) return;

        // Ensure allBooksCache is defined
        if (typeof allBooksCache === "undefined") {
          allBooksCache = [];
        }

        // If cache is empty, load all books first
        if (!Array.isArray(allBooksCache) || allBooksCache.length === 0) {
          loadAllBooksAndRender();
          return;
        }

        let books = [...allBooksCache];

        // Filter by category
        if (currentCategory && currentCategory !== "semua") {
          books = books.filter(
            (b) =>
              (b.kategori || "").toLowerCase() === currentCategory.toLowerCase()
          );
        }

        // Filter by search - this is the key connection between search and display
        const keyword = searchBukuInput
          ? searchBukuInput.value.trim().toLowerCase()
          : "";
        if (keyword) {
          books = books.filter(
            (b) =>
              (b.namaBuku || "").toLowerCase().includes(keyword) ||
              (b.penulis || "").toLowerCase().includes(keyword) ||
              (b.penerbit || "").toLowerCase().includes(keyword) ||
              (b.idBuku || "").toLowerCase().includes(keyword)
          );
          console.log(
            `Searching for: "${keyword}" - Found ${books.length} results`
          );
        }

        // Sort
        const sortVal = sortBuku ? sortBuku.value : "title-asc";
        if (sortVal === "title-asc") {
          books.sort((a, b) =>
            (a.namaBuku || "")
              .toString()
              .localeCompare((b.namaBuku || "").toString(), "id", {
                sensitivity: "base",
              })
          );
        } else if (sortVal === "year-desc") {
          books.sort(
            (a, b) =>
              (parseInt(b.tahunTerbit, 10) || 0) -
              (parseInt(a.tahunTerbit, 10) || 0)
          );
        } else if (sortVal === "year-asc") {
          books.sort(
            (a, b) =>
              (parseInt(a.tahunTerbit, 10) || 0) -
              (parseInt(b.tahunTerbit, 10) || 0)
          );
        }

        // Clear container
        semuaBukuList.innerHTML = "";

        if (books.length === 0) {
          semuaBukuList.innerHTML =
            '<div class="text-muted text-center py-5"><i class="fas fa-search me-2"></i>Tidak ada buku ditemukan</div>';
          return;
        }

        // Update section title to show search results count
        const sectionTitle = document.getElementById("sectionTitle");
        if (sectionTitle) {
          if (keyword) {
            sectionTitle.textContent = `Hasil Pencarian "${keyword}" (${books.length} buku)`;
          } else if (currentCategory && currentCategory !== "semua") {
            sectionTitle.textContent = `Kategori ${currentCategory} (${books.length} buku)`;
          } else {
            sectionTitle.textContent = `Semua Buku (${books.length} buku)`;
          }
        }

        // Render books with proper styling and click handlers
        const row = document.createElement("div");
        row.className = "row";

        books.forEach((book) => {
          const col = document.createElement("div");
          col.className = "col-md-2 mb-3";
          col.innerHTML = `
          <div class="card h-100">
            <img class="card-img-top" alt="${
              book.namaBuku
            }" style="height:180px;object-fit:cover">
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-truncate" title="${
                book.namaBuku
              }">${book.namaBuku}</h6>
              <p class="card-text">
                <small class="text-muted d-block mb-1">
                  <i class="fas fa-user me-1"></i>${book.penulis}
                </small>
                <small class="text-info d-block mb-1">
                  <i class="fas fa-building me-1"></i>${book.penerbit}
                </small>
                <small class="text-secondary d-block mb-2">
                  <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                </small>
                <span class="badge bg-primary d-block mb-2">${
                  book.kategori || "Umum"
                }</span>
                ${
                  book.rak
                    ? `<small class="text-secondary d-block mb-2"><i class="fas fa-map-marker-alt me-1"></i>Rak: ${book.rak}</small>`
                    : ""
                }
                <span class="badge ${
                  book.stok > 0 ? "bg-success" : "bg-danger"
                }">
                  <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                </span>
              </p>
            </div>
            <div class="card-footer bg-transparent border-0 p-2">
              <small class="text-muted">
                <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
              </small>
            </div>
          </div>
        `;

          // Add click handler to open book modal
          col
            .querySelector(".card")
            .addEventListener("click", () => openBookModal(book));

          // Set book image
          setBookImage(col.querySelector(".card-img-top"), book);

          row.appendChild(col);
        });

        semuaBukuList.appendChild(row);
      }

      // Filter by category
      function filterByCategory(category) {
        currentCategory = category;
        // Clear search when filtering by category
        const searchInput = document.getElementById("searchBukuInput");
        if (searchInput) searchInput.value = "";
        renderBooksWithSortAndSearch();
      }

      // Global function to load all books and render
      async function loadAllBooksAndRender() {
        const semuaBukuList = document.getElementById("semuaBukuList");
        if (!semuaBukuList) return;

        // Ensure allBooksCache is defined
        if (typeof allBooksCache === "undefined") {
          allBooksCache = [];
        }

        // Show loading state briefly
        semuaBukuList.innerHTML =
          '<div class="text-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
          const res = await fetch("/api/books");
          let books = await res.json();

          // Store original books in a separate variable to preserve full dataset
          window.allBooksOriginal = books;
          allBooksCache = books;

          console.log("Loaded books:", books.length);

          // Clear search input when loading all books
          const searchInput = document.getElementById("searchBukuInput");
          if (searchInput) searchInput.value = "";

          // Render immediately with current sort
          renderBooksWithSortAndSearch();
        } catch (e) {
          console.error("Error loading books:", e);
          semuaBukuList.innerHTML =
            '<div class="text-danger text-center">Gagal memuat semua buku</div>';
        }
      }

      // Synopsis map (sinopsis singkat)
      const BOOK_SYNOPSIS = {
        "Laskar Pelangi":
          "Novel inspiratif tentang perjuangan sepuluh anak Belitung di sekolah sederhana; persahabatan, optimisme, dan kekuatan pendidikan.",
        "Bumi Manusia":
          "Kisah cinta Minke dan Annelies di tengah penindasan kolonial; potret perlawanan terhadap ketidakadilan.",
        "Negeri 5 Menara":
          "Enam santri yang memegang prinsip man jadda wajada; mimpi, persahabatan, dan daya juang.",
        "Ayat-Ayat Cinta":
          "Romansa religius Fahri di Mesir; ujian cinta dan iman dengan nilai moral-spiritual.",

        "Filosofi Kopi":
          "Kumpulan cerita seputar Ben sang barista; refleksi hidup sederhana namun dalam melalui secangkir kopi.",
        "Perahu Kertas":
          "Perjalanan Keenan dan Kugy mencari jati diri, mimpi, dan cinta; kisah coming-of-age.",
        Pulang:
          "Bujang dan organisasi rahasia; aksi, persahabatan, serta pencarian identitas.",
        "Orang-Orang Biasa":
          "Sekelompok orang kecil mencoba mengubah nasib; persahabatan, mimpi, dan perjuangan.",
        "Tentang Kamu":
          "Pengacara muda mengurai warisan misterius; kisah hidup penuh pelajaran berharga.",
        Hujan:
          "Lail dan Esok di masa depan yang dilanda bencana; cinta, kehilangan, dan ketabahan.",
        Rindu:
          "Para jamaah haji abad ke-19; rahasia, penyesalan, dan harapan selama pelayaran panjang.",
        "Cantik Itu Luka":
          "Magis realisme tentang Dewi Ayu; satir sejarah, cinta, dan luka bangsa.",
        "Sejarah Dunia yang Disembunyikan":
          "Nonfiksi teori alternatif sejarah; sisi tersembunyi peradaban, keyakinan, dan kuasa.",
        "Atomic Habits":
          "Panduan kebiasaan kecil berdampak besar; bangun kebiasaan baik, hilangkan yang buruk.",
        Sapiens:
          "Perjalanan Homo sapiens hingga modern; budaya, agama, dan sains membentuk peradaban.",
        "Homo Deus":
          "Gagasan masa depan manusia, AI, dan bioteknologi; arah peradaban yang menggugah.",
        "The Power of Habit":
          "Bagaimana kebiasaan terbentuk dan berubah; contoh dari individu hingga perusahaan.",
        "Rich Dad Poor Dad":
          "Kontras pola pikir uang; pelajaran finansial menuju kebebasan keuangan.",
        "Think and Grow Rich":
          "Klasik motivasi pola pikir sukses; wawancara tokoh kaya pada masanya.",
        "7 Habits of Highly Effective People":
          "Tujuh kebiasaan untuk efektivitas pribadi; fokus pada diri, waktu, dan relasi.",
      };

      function openBookModal(book) {
        const titleEl = document.getElementById("bookModalTitle");
        const h5Title = document.getElementById("bookTitle");
        const authorEl = document.getElementById("bookAuthor");
        const synEl = document.getElementById("bookSynopsis");
        const pubEl = document.getElementById("bookPublisher");
        const yearEl = document.getElementById("bookYear");
        const idEl = document.getElementById("bookId");
        const stockEl = document.getElementById("bookStock");
        const coverImgEl = document.getElementById("bookCoverImg");

        const synopsis =
          BOOK_SYNOPSIS[book.namaBuku] ||
          BOOK_SYNOPSIS[(book.namaBuku || "").split(":")[0]] ||
          "Sinopsis belum tersedia.";

        titleEl.textContent = "Detail Buku";
        h5Title.textContent = book.namaBuku;
        authorEl.textContent = book.penulis;
        synEl.textContent = synopsis;
        pubEl.textContent = book.penerbit;
        yearEl.textContent = book.tahunTerbit;
        idEl.textContent = book.idBuku;
        stockEl.textContent = book.stok;

        // Set cover image using the same fallback logic as cards
        if (coverImgEl) {
          setBookImage(coverImgEl, book);
        }

        const modal = new bootstrap.Modal(document.getElementById("bookModal"));
        modal.show();
      }

      // Helper: sanitasi nama file dan path gambar lokal
      function sanitizeForFilename(str) {
        return (str || "")
          .toString()
          .normalize("NFKD")
          .replace(/[^\w\s-]/g, "")
          .trim()
          .replace(/[\s_]+/g, "-")
          .toLowerCase();
      }
      function getImageCandidates(book) {
        const baseDir = "/images";
        const title = book?.namaBuku || "";
        const rawJpg = `${baseDir}/${title}.jpg`;
        const rawPng = `${baseDir}/${title}.png`;
        const sanitized = sanitizeForFilename(title);
        const sanJpg = `${baseDir}/${sanitized}.jpg`;
        const sanPng = `${baseDir}/${sanitized}.png`;
        // Also try a short form using the first word of the title (e.g. 'Sapiens')
        const firstWord = (title || "").split(" ")[0] || "";
        const firstSan = sanitizeForFilename(firstWord);
        const firstSanJpg = `${baseDir}/${firstSan}.jpg`;
        const firstSanPng = `${baseDir}/${firstSan}.png`;
        return [rawJpg, rawPng, sanJpg, sanPng, firstSanJpg, firstSanPng];
      }
      // For modal cover: pick a reasonable default; inline onerror will try PNG
      function getBookImageSrc(book) {
        const candidates = getImageCandidates(book);
        // Prefer sanitized JPG first
        return candidates[2];
      }
      function setBookImage(imgEl, book) {
        const candidates = getImageCandidates(book);
        let idx = 0;
        function tryNext() {
          if (idx >= candidates.length) {
            imgEl.onerror = null;
            imgEl.src = "https://via.placeholder.com/300x180?text=No+Image";
            return;
          }
          const src = candidates[idx++];
          // Encode spaces safely but keep slashes
          const parts = src.split("/");
          parts[parts.length - 1] = encodeURIComponent(parts[parts.length - 1]);
          imgEl.src = parts.join("/");
        }
        imgEl.onerror = tryNext;
        tryNext();
      }

      // Load system settings from server
      async function loadSystemSettings() {
        try {
          const response = await fetch(`${API_BASE}/admin/settings`);
          if (response.ok) {
            const settings = await response.json();
            systemSettings = { ...systemSettings, ...settings };
            // Update library name in UI if available
            const libraryTitle = document.querySelector(
              ".navbar-brand, .sidebar h4, h1"
            );
            if (libraryTitle && settings.libraryName) {
              libraryTitle.innerHTML = `<div class="site-brand"><img src="/images/school_logo.png" alt="logo" class="site-logo"><div class="site-name">${settings.libraryName}</div></div>`;
            }
          }
        } catch (error) {
          console.warn("Failed to load system settings:", error);
        }
      }

      // Load user data and dashboard metrics based on current login
      async function loadUserData() {
        const name = localStorage.getItem("username") || "User";
        const userId = localStorage.getItem("userid");
        const h3 = document.querySelector("h3");
        const dd = document.querySelector(".dropdown-toggle");
        if (h3) h3.textContent = `Halo, ${name} 👋`;
        if (dd) dd.textContent = `👤 ${name}`;

        // If not logged in, keep default dashboard numbers
        if (!userId) return;

        try {
          // Load active loans for this user
          const [loansRes, returnsRes, booksRes] = await Promise.all([
            fetch(
              `${API_BASE}/loans?userId=${encodeURIComponent(
                userId
              )}&status=aktif`
            ),
            fetch(`${API_BASE}/returns?userId=${encodeURIComponent(userId)}`),
            fetch(`${API_BASE}/books`),
          ]);
          const [activeLoans, userReturns, allBooks] = await Promise.all([
            loansRes.json(),
            returnsRes.json(),
            booksRes.json(),
          ]);

          // Buku Dipinjam - hanya update jika cards terlihat (di home)
          const dashboardCards = document.getElementById("dashboardCards");
          if (dashboardCards && dashboardCards.style.display !== "none") {
            const borrowedCount = Array.isArray(activeLoans)
              ? activeLoans.length
              : 0;
            const borrowedEl = document.querySelector(".card-blue h3");
            if (borrowedEl) borrowedEl.textContent = String(borrowedCount);

            // Jatuh tempo terdekat — tampilkan semua judul jika tanggalnya sama
            const today = new Date();
            let nearest = null;
            activeLoans.forEach((l) => {
              const due = new Date(l.tanggalKembali);
              if (!nearest || due < nearest) nearest = due;
            });
            const dueEl = document.querySelector(".card-green p");
            if (dueEl) {
              if (!nearest) {
                dueEl.innerHTML = "—";
              } else {
                const sameDueLoans = activeLoans.filter(
                  (l) =>
                    new Date(l.tanggalKembali).toDateString() ===
                    nearest.toDateString()
                );
                const titles = sameDueLoans.map((l) => {
                  const book = allBooks.find((b) => b.idBuku === l.idBuku);
                  return book ? book.namaBuku : l.idBuku;
                });
                const uniqueTitles = [...new Set(titles)];
                const daysLeft = Math.ceil(
                  (nearest - today) / (1000 * 60 * 60 * 24)
                );
                if (daysLeft <= 0 || activeLoans.length === 0) {
                  dueEl.innerHTML = "—";
                } else {
                  dueEl.innerHTML = `${uniqueTitles.join(
                    ", "
                  )}<br><small>${daysLeft} hari lagi</small>`;
                }
              }
            }
          }
        } catch (err) {
          // silent fail to avoid breaking UI
          console.error("Failed to load dashboard data:", err);
        }
      }

      // Removed: payment functions (denda feature removed)

      // Live refresh for dashboard cards (Buku Dipinjam & Jatuh Tempo Terdekat)
      async function refreshDashboardCardsLive() {
        const userId = localStorage.getItem("userid");
        if (!userId) return;
        try {
          const [loansRes, booksRes] = await Promise.all([
            fetch(
              `${API_BASE}/loans?userId=${encodeURIComponent(
                userId
              )}&status=aktif`
            ),
            fetch(`${API_BASE}/books`),
          ]);
          const [activeLoans, allBooks] = await Promise.all([
            loansRes.json(),
            booksRes.json(),
          ]);

          // Buku Dipinjam - hanya update jika cards terlihat (di home)
          const dashboardCards = document.getElementById("dashboardCards");
          if (dashboardCards && dashboardCards.style.display !== "none") {
            const borrowedCount = Array.isArray(activeLoans)
              ? activeLoans.length
              : 0;
            const borrowedEl = document.querySelector(".card-blue h3");
            if (borrowedEl) borrowedEl.textContent = String(borrowedCount);

            // Jatuh Tempo Terdekat - hanya tampilkan jika ada pinjaman aktif
            const today = new Date();
            let nearest = null;
            (activeLoans || []).forEach((l) => {
              const due = new Date(l.tanggalKembali);
              if (!nearest || due < nearest) nearest = due;
            });
            const dueEl = document.querySelector(".card-green p");
            if (dueEl) {
              if (!nearest || activeLoans.length === 0) {
                dueEl.innerHTML = "—";
              } else {
                const sameDueLoans = activeLoans.filter(
                  (l) =>
                    new Date(l.tanggalKembali).toDateString() ===
                    nearest.toDateString()
                );
                const titles = sameDueLoans.map((l) => {
                  const book = allBooks.find((b) => b.idBuku === l.idBuku);
                  return book ? book.namaBuku : l.idBuku;
                });
                const uniqueTitles = [...new Set(titles)];
                const daysLeft = Math.ceil(
                  (nearest - today) / (1000 * 60 * 60 * 24)
                );
                if (daysLeft <= 0) {
                  dueEl.innerHTML = "—";
                } else {
                  dueEl.innerHTML = `${uniqueTitles.join(
                    ", "
                  )}<br><small>${daysLeft} hari lagi</small>`;
                }
              }
            }
          }
        } catch (err) {
          console.error("Error refreshing dashboard cards:", err);
        }
      }

      // Load popular books
      async function loadPopularBooks() {
        try {
          const response = await fetch(`${API_BASE}/books/popular`);
          const popularBooks = await response.json();

          // Load all books for global access
          const allBooksResponse = await fetch(`${API_BASE}/books`);
          books = await allBooksResponse.json();

          const booksContainer = document.querySelector(".popular-books");
          booksContainer.innerHTML = "";

          popularBooks.forEach((book) => {
            const bookCard = document.createElement("div");
            bookCard.className = "col-md-2";
            bookCard.innerHTML = `
            <div class="card">
              <img class="card-img-top" alt="${book.namaBuku}">
              <div class="card-body p-2 text-center">
                <small>${book.namaBuku}</small>
                <br><small class="text-muted">${book.penulis}</small>
                <br><small class="text-success">Stok: ${book.stok}</small>
              </div>
            </div>
          `;
            setBookImage(bookCard.querySelector(".card-img-top"), book);
            bookCard
              .querySelector(".card")
              .addEventListener("click", () => openBookModal(book));
            booksContainer.appendChild(bookCard);
          });
        } catch (error) {
          console.error("Error loading popular books:", error);
        }
      }

      // Load all books
      async function loadAllBooks() {
        const resultsContainer = document.querySelector(".popular-books");
        const sectionTitle = document.getElementById("sectionTitle");

        // Show loading state
        if (sectionTitle) {
          sectionTitle.textContent = "Memuat Semua Buku...";
        }
        if (resultsContainer) {
          resultsContainer.innerHTML =
            '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }

        try {
          const response = await fetch(`${API_BASE}/books`);
          books = await response.json();
          displayAllBooks(books);
        } catch (error) {
          console.error("Error loading all books:", error);
          if (resultsContainer) {
            resultsContainer.innerHTML =
              '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat data buku</div>';
          }
          if (sectionTitle) {
            sectionTitle.textContent = "Semua Buku";
          }
        }
      }

      // Display all books with sorting
      function displayAllBooks(books) {
        const resultsContainer = document.querySelector(".popular-books");
        const sectionTitle = document.getElementById("sectionTitle");
        const sortSelect = document.getElementById("sortBuku");

        if (!resultsContainer) return;

        // Apply sorting if sort dropdown exists
        let sortedBooks = [...books];
        if (sortSelect) {
          const sortValue = sortSelect.value;
          if (sortValue === "title-asc") {
            sortedBooks.sort((a, b) =>
              (a.namaBuku || "")
                .toString()
                .localeCompare((b.namaBuku || "").toString(), "id", {
                  sensitivity: "base",
                })
            );
          } else if (sortValue === "year-desc") {
            sortedBooks.sort(
              (a, b) =>
                (parseInt(b.tahunTerbit, 10) || 0) -
                (parseInt(a.tahunTerbit, 10) || 0)
            );
          } else if (sortValue === "year-asc") {
            sortedBooks.sort(
              (a, b) =>
                (parseInt(a.tahunTerbit, 10) || 0) -
                (parseInt(b.tahunTerbit, 10) || 0)
            );
          }
        }

        // Update section title
        if (sectionTitle) {
          sectionTitle.textContent = `Semua Buku (${sortedBooks.length} buku)`;
        }

        resultsContainer.innerHTML = "";

        if (sortedBooks.length === 0) {
          resultsContainer.innerHTML =
            '<div class="col-12 text-center text-muted"><i class="fas fa-book-open me-2"></i>Tidak ada buku tersedia</div>';
          return;
        }

        sortedBooks.forEach((book) => {
          const bookCard = document.createElement("div");
          bookCard.className = "col-md-2 mb-3";
          bookCard.innerHTML = `
          <div class="card h-100">
            <img class="card-img-top" alt="${book.namaBuku}">
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-truncate" title="${
                book.namaBuku
              }">${book.namaBuku}</h6>
              <p class="card-text">
                <small class="text-muted d-block mb-1">
                  <i class="fas fa-user me-1"></i>${book.penulis}
                </small>
                <small class="text-info d-block mb-1">
                  <i class="fas fa-building me-1"></i>${book.penerbit}
                </small>
                <small class="text-secondary d-block mb-2">
                  <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                </small>
                ${
                  book.rak
                    ? `<small class="text-secondary d-block mb-2"><i class="fas fa-map-marker-alt me-1"></i>Rak: ${book.rak}</small>`
                    : ""
                }
                <span class="badge ${
                  book.stok > 0 ? "bg-success" : "bg-danger"
                }">
                  <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                </span>
              </p>
            </div>
            <div class="card-footer bg-transparent border-0 p-2">
              <small class="text-muted">
                <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
              </small>
            </div>
          </div>
        `;
          bookCard
            .querySelector(".card")
            .addEventListener("click", () => openBookModal(book));
          setBookImage(bookCard.querySelector(".card-img-top"), book);
          resultsContainer.appendChild(bookCard);
        });
      }

      // Search functionality
      function setupSearch() {
        // Setup search after elements are created
        setTimeout(() => {
          const searchInput = document.getElementById("searchBukuInput");
          const searchButton = document.getElementById("btnCariBuku");

          console.log("Setting up search...", { searchInput, searchButton });

          if (searchInput && searchButton) {
            // Remove any existing listeners
            searchButton.onclick = null;
            searchInput.onkeypress = null;

            // Add new listeners
            searchButton.onclick = function (e) {
              e.preventDefault();
              console.log("Search button clicked");
              handleSearch();
            };

            searchInput.onkeypress = function (e) {
              if (e.key === "Enter") {
                e.preventDefault();
                console.log("Enter pressed in search input");
                handleSearch();
              }
            };

            console.log("Search setup completed successfully");
          } else {
            console.log("Search elements not found:", {
              searchInput,
              searchButton,
            });
            // Try again after a longer delay
            setTimeout(() => {
              const retrySearchInput =
                document.getElementById("searchBukuInput");
              const retrySearchButton = document.getElementById("btnCariBuku");
              if (retrySearchInput && retrySearchButton) {
                retrySearchButton.onclick = function (e) {
                  e.preventDefault();
                  console.log("Retry search button clicked");
                  handleSearch();
                };
                retrySearchInput.onkeypress = function (e) {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    console.log("Retry enter pressed in search input");
                    handleSearch();
                  }
                };
                console.log("Search setup completed on retry");
              }
            }, 500);
          }
        }, 200);
      }

      async function handleSearch() {
        console.log("=== SEARCH FUNCTION CALLED ===");
        const searchInput = document.getElementById("searchBukuInput");
        const query = searchInput ? searchInput.value.trim() : "";

        // Ensure allBooksCache is defined
        if (typeof allBooksCache === "undefined") {
          allBooksCache = [];
        }

        console.log("Search query:", query);
        console.log("Current allBooksCache length:", allBooksCache.length);
        console.log(
          "Current allBooksOriginal length:",
          window.allBooksOriginal ? window.allBooksOriginal.length : "undefined"
        );

        if (query) {
          try {
            // Use original books dataset for search
            let booksToSearch = window.allBooksOriginal || allBooksCache;

            // If no original dataset, fetch from server
            if (!Array.isArray(booksToSearch) || booksToSearch.length === 0) {
              console.log("Fetching books from server...");
              const allBooksRes = await fetch("/api/books");
              booksToSearch = await allBooksRes.json();
              window.allBooksOriginal = booksToSearch;
              console.log("Fetched books from server:", booksToSearch.length);
            }

            console.log(
              "Searching in dataset with",
              booksToSearch.length,
              "books"
            );

            // Filter books locally
            const filtered = booksToSearch.filter((b) => {
              const namaMatch = (b.namaBuku || "")
                .toLowerCase()
                .includes(query.toLowerCase());
              const penulisMatch = (b.penulis || "")
                .toLowerCase()
                .includes(query.toLowerCase());
              const penerbitMatch = (b.penerbit || "")
                .toLowerCase()
                .includes(query.toLowerCase());
              const idMatch = (b.idBuku || "")
                .toLowerCase()
                .includes(query.toLowerCase());

              if (namaMatch || penulisMatch || penerbitMatch || idMatch) {
                console.log("Found match:", b.namaBuku);
              }

              return namaMatch || penulisMatch || penerbitMatch || idMatch;
            });

            console.log("Filtered results:", filtered.length);

            // Store filtered results and render
            allBooksCache = filtered;
            // Force re-render with search results
            renderBooksWithSortAndSearch();
          } catch (error) {
            console.error("Error searching books:", error);
          }
        } else {
          console.log("Empty search - restoring all books");
          // If search is empty, restore original dataset
          if (window.allBooksOriginal) {
            allBooksCache = window.allBooksOriginal;
            // Clear search input
            if (searchInput) searchInput.value = "";
            renderBooksWithSortAndSearch();
          } else {
            loadAllBooksAndRender();
          }
        }
      }

      // Sort functionality
      function setupSortHandlers() {
        // Use event delegation to survive DOM re-rendering
        document.addEventListener("change", (e) => {
          if (e.target && e.target.id === "sortBuku") {
            // Check if we're in "Semua Buku" view
            const sectionTitle = document.getElementById("sectionTitle");
            if (
              sectionTitle &&
              sectionTitle.textContent.includes("Semua Buku")
            ) {
              // Re-render with current books and new sort
              if (typeof renderBooksWithSortAndSearch === "function") {
                renderBooksWithSortAndSearch();
              } else {
                // Fallback: reload all books with sorting
                loadAllBooks();
              }
            }
          }
        });
      }

      // Load available books
      async function loadAvailableBooks() {
        const resultsContainer = document.querySelector(".popular-books");
        const sectionTitle = document.getElementById("sectionTitle");

        // Show loading state
        if (sectionTitle) {
          sectionTitle.textContent = "Memuat Buku Tersedia...";
        }
        if (resultsContainer) {
          resultsContainer.innerHTML =
            '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }

        try {
          const response = await fetch(`${API_BASE}/books/available`);
          const availableBooks = await response.json();

          // Load all books for global access
          const allBooksResponse = await fetch(`${API_BASE}/books`);
          books = await allBooksResponse.json();

          displayAvailableBooks(availableBooks);
        } catch (error) {
          console.error("Error loading available books:", error);
          if (resultsContainer) {
            resultsContainer.innerHTML =
              '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Gagal memuat data buku</div>';
          }
          if (sectionTitle) {
            sectionTitle.textContent = "Buku Tersedia";
          }
        }
      }

      // Display available books
      function displayAvailableBooks(books) {
        const resultsContainer = document.querySelector(".popular-books");
        const sectionTitle = document.getElementById("sectionTitle");

        if (!resultsContainer) return;

        // Update section title
        if (sectionTitle) {
          sectionTitle.textContent = `Buku Tersedia (${books.length} buku)`;
        }

        resultsContainer.innerHTML = "";

        if (books.length === 0) {
          resultsContainer.innerHTML =
            '<div class="col-12 text-center text-muted"><i class="fas fa-book-open me-2"></i>Tidak ada buku tersedia</div>';
          return;
        }

        books.forEach((book) => {
          const bookCard = document.createElement("div");
          bookCard.className = "col-md-2 mb-3";
          bookCard.innerHTML = `
          <div class="card h-100">
            <img class="card-img-top" alt="${book.namaBuku}">
            <div class="card-body p-3">
              <h6 class="card-title fw-bold text-truncate" title="${
                book.namaBuku
              }">${book.namaBuku}</h6>
              <p class="card-text">
                <small class="text-muted d-block mb-1">
                  <i class="fas fa-user me-1"></i>${book.penulis}
                </small>
                <small class="text-info d-block mb-1">
                  <i class="fas fa-building me-1"></i>${book.penerbit}
                </small>
                <small class="text-secondary d-block mb-2">
                  <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                </small>
                ${
                  book.rak
                    ? `<small class="text-secondary d-block mb-2"><i class="fas fa-map-marker-alt me-1"></i>Rak: ${book.rak}</small>`
                    : ""
                }
                <span class="badge bg-success">
                  <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                </span>
              </p>
            </div>
            <div class="card-footer bg-transparent border-0 p-2">
              <small class="text-muted">
                <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
              </small>
            </div>
          </div>
        `;
          bookCard
            .querySelector(".card")
            .addEventListener("click", () => openBookModal(book));
          setBookImage(bookCard.querySelector(".card-img-top"), book);
          resultsContainer.appendChild(bookCard);
        });
      }

      // Load latest books (published within the last 1 year)
      async function loadLatestBooks() {
        const resultsContainer = document.querySelector(".popular-books");
        const sectionTitle = document.getElementById("sectionTitle");
        if (sectionTitle) sectionTitle.textContent = "Buku Terbaru";
        if (resultsContainer) {
          resultsContainer.innerHTML =
            '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }
        try {
          const response = await fetch(`${API_BASE}/books/latest`);
          const latestBooks = await response.json();
          const allBooksResponse = await fetch(`${API_BASE}/books`);
          books = await allBooksResponse.json();
          if (!resultsContainer) return;
          resultsContainer.innerHTML = "";
          if (!latestBooks || latestBooks.length === 0) {
            resultsContainer.innerHTML =
              '<div class="col-12 text-center text-muted py-5"><i class="fas fa-book-open fa-3x mb-3"></i><div>Belum ada buku terbaru</div></div>';
            return;
          }
          latestBooks.forEach((book) => {
            const bookCard = document.createElement("div");
            bookCard.className = "col-md-2 mb-3";
            bookCard.innerHTML = `
            <div class="card h-100">
              <img class="card-img-top" alt="${book.namaBuku}">
              <div class="card-body p-3">
                <h6 class="card-title fw-bold text-truncate" title="${
                  book.namaBuku
                }">${book.namaBuku}</h6>
                <p class="card-text">
                  <small class="text-muted d-block mb-1">
                    <i class="fas fa-user me-1"></i>${book.penulis}
                  </small>
                  <small class="text-info d-block mb-1">
                    <i class="fas fa-building me-1"></i>${book.penerbit}
                  </small>
                  <small class="text-secondary d-block mb-2">
                    <i class="fas fa-calendar me-1"></i>${book.tahunTerbit}
                  </small>
                  ${
                    book.rak
                      ? `<small class="text-secondary d-block mb-2"><i class="fas fa-map-marker-alt me-1"></i>Rak: ${book.rak}</small>`
                      : ""
                  }
                  <span class="badge ${
                    book.stok > 0 ? "bg-success" : "bg-danger"
                  }">
                    <i class="fas fa-box me-1"></i>Stok: ${book.stok}
                  </span>
                </p>
              </div>
              <div class="card-footer bg-transparent border-0 p-2">
                <small class="text-muted">
                  <i class="fas fa-barcode me-1"></i>ID: ${book.idBuku}
                </small>
              </div>
            </div>`;
            setBookImage(bookCard.querySelector(".card-img-top"), book);
            bookCard
              .querySelector(".card")
              .addEventListener("click", () => openBookModal(book));
            resultsContainer.appendChild(bookCard);
          });
        } catch (e) {
          if (resultsContainer) {
            resultsContainer.innerHTML =
              '<div class="col-12 text-center text-danger">Gagal memuat buku terbaru</div>';
          }
        }
      }

      // Show all books page with search and sort
      function showAllBooks() {
        // Hide dashboard cards
        const dashboardCards = document.getElementById("dashboardCards");
        if (dashboardCards) {
          dashboardCards.style.display = "none";
        }

        // Hide all other content (but not the search section we're about to create)
        document.querySelectorAll(".card").forEach((card) => {
          if (!card.closest(".modal") && !card.closest("#searchSemuaBuku")) {
            card.style.display = "none";
          }
        });

        // Create or show search and books section
        let searchSection = document.getElementById("searchSemuaBuku");
        if (!searchSection) {
          searchSection = document.createElement("div");
          searchSection.id = "searchSemuaBuku";
          searchSection.className = "mb-3";
          searchSection.innerHTML = `
          <div class="card mb-3">
            <div class="card-body">
      <div class="row align-items-end">
        <div class="col-12">
          <h5 id="sectionTitle" class="mb-3">Buku Populer Minggu Ini</h5>
        </div>
        <div class="col-md-8">
                  <label for="searchBukuInput" class="form-label">Cari Buku</label>
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Cari buku (judul, penulis, ISBN)..." aria-label="Cari buku" id="searchBukuInput">
                    <button class="btn btn-primary" type="button" id="btnCariBuku">Cari</button>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="sortBuku" class="form-label">Urutkan</label>
                  <select class="form-select" id="sortBuku">
                    <option value="title-asc">Judul (A-Z)</option>
                    <option value="year-desc">Tahun Terbaru</option>
                    <option value="year-asc">Tahun Terlama</option>
                  </select>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <label class="form-label d-block mb-2">Kategori Buku:</label>
                  <div class="btn-group flex-wrap" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="filterByCategory('semua')">Semua</button>
                    <button type="button" class="btn btn-outline-info" onclick="filterByCategory('Fiksi')">Fiksi</button>
                    <button type="button" class="btn btn-outline-success" onclick="filterByCategory('Fantasi')">Fantasi</button>
                    <button type="button" class="btn btn-outline-warning" onclick="filterByCategory('Pengetahuan')">Pengetahuan</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="semuaBukuList"></div>
        `;

          // Insert search section after the dashboard info cards (row with 3 cards)
          const dashboardRow = document.querySelector(".row.mb-4");
          if (dashboardRow) {
            dashboardRow.insertAdjacentElement("afterend", searchSection);
          } else {
            document.querySelector(".content").appendChild(searchSection);
          }

          // Setup search functionality after creating the elements
          setTimeout(() => {
            console.log("Setting up search and sort handlers...");
            setupSearch();
            setupSortHandlers();
          }, 100);
        }

        searchSection.style.display = "block";
        // Hide default popular-books grid to avoid duplicate lists
        const popularGrid = document.querySelector(".popular-books");
        if (popularGrid) popularGrid.innerHTML = "";

        // Update section title
        const titleEl = document.getElementById("sectionTitle");
        if (titleEl) {
          titleEl.textContent = "Semua Buku";
        }

        // Load books immediately
        loadAllBooksAndRender();
      }

      // Setup submenu click handlers
      function setupSubmenuHandlers() {
        // Buku Tersedia submenu
        const allLinks = document.querySelectorAll('a[href="#"]');
        allLinks.forEach((link) => {
          if (link.textContent.includes("Buku Tersedia")) {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              // Hide search section
              const searchSection = document.getElementById("searchSemuaBuku");
              if (searchSection) {
                searchSection.style.display = "none";
              }
              // Show all cards
              document.querySelectorAll(".card").forEach((card) => {
                if (!card.closest(".modal")) {
                  card.style.display = "block";
                }
              });
              // Load available books
              loadAvailableBooks();
            });
          }

          if (link.textContent.includes("Buku Terbaru")) {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              // Hide search section
              const searchSection = document.getElementById("searchSemuaBuku");
              if (searchSection) {
                searchSection.style.display = "none";
              }
              // Show all cards
              document.querySelectorAll(".card").forEach((card) => {
                if (!card.closest(".modal")) {
                  card.style.display = "block";
                }
              });
              // Load latest books from server
              loadLatestBooks();
            });
          }
        });

        // Home link: restore home view
        const homeLink = document.getElementById("homeLink");
        if (homeLink) {
          homeLink.addEventListener("click", (e) => {
            e.preventDefault();
            // Hide search section if exists
            const searchSection = document.getElementById("searchSemuaBuku");
            if (searchSection) {
              searchSection.style.display = "none";
            }
            // Show dashboard cards
            const dashboardCards = document.getElementById("dashboardCards");
            if (dashboardCards) {
              dashboardCards.style.display = "";
            }
            // Show all cards again
            document.querySelectorAll(".card").forEach((card) => {
              if (!card.closest(".modal")) {
                card.style.display = "block";
              }
            });
            // Restore home title and popular books
            const titleEl = document.getElementById("sectionTitle");
            const container = document.querySelector(".popular-books");
            if (titleEl) titleEl.textContent = "Buku Populer Minggu Ini";
            if (container) loadPopularBooks();
          });
        }
      }

      // Loan functions moved to external file: data_pinjam.js

      // Global function for easy testing
      window.testSearch = function (query) {
        const searchInput = document.getElementById("searchBukuInput");
        if (searchInput) {
          searchInput.value = query;
          handleSearch();
        } else {
          console.log("Search input not found!");
        }
      };

      window.clearSearch = function () {
        const searchInput = document.getElementById("searchBukuInput");
        if (searchInput) {
          searchInput.value = "";
          handleSearch();
        } else {
          console.log("Search input not found!");
        }
      };

      // Debug function to check search elements
      window.debugSearch = function () {
        console.log("=== DEBUG SEARCH ELEMENTS ===");
        const searchInput = document.getElementById("searchBukuInput");
        const searchButton = document.getElementById("btnCariBuku");
        const semuaBukuList = document.getElementById("semuaBukuList");

        console.log("Search Input:", searchInput);
        console.log("Search Button:", searchButton);
        console.log("Semua Buku List:", semuaBukuList);
        console.log("All Books Cache:", allBooksCache.length);
        console.log(
          "All Books Original:",
          window.allBooksOriginal ? window.allBooksOriginal.length : "undefined"
        );

        if (searchInput && searchButton) {
          console.log("Search elements found - testing click...");
          searchButton.click();
        } else {
          console.log("Search elements NOT found!");
        }
      };

      // Test different search queries
      window.testSearchQueries = function () {
        console.log("Testing search functionality...");

        // Test searches
        const testQueries = [
          "atomic", // Should find Atomic Habits
          "laskar", // Should find Laskar Pelangi
          "habits", // Should find books with habits
          "B001", // Should find book with ID B001
          "gramedia", // Should find books from Gramedia
          "pramoedya", // Should find books by Pramoedya
          "nonexistent", // Should find nothing
        ];

        testQueries.forEach((query, index) => {
          setTimeout(() => {
            console.log(`Testing query ${index + 1}: "${query}"`);
            testSearch(query);
          }, index * 2000);
        });

        // Clear search after all tests
        setTimeout(() => {
          console.log("Clearing search...");
          clearSearch();
        }, testQueries.length * 2000 + 1000);
      };

      // Initialize page
      document.addEventListener("DOMContentLoaded", async () => {
        // Load system settings first
        await loadSystemSettings();
        loadUserData();
        // live refresh every 2s to keep cards updated
        setInterval(refreshDashboardCardsLive, 2000);
        loadPopularBooks();
        setupSearch();
        setupSortHandlers();
        setupSubmenuHandlers();
      });
    </script>
    <script type="module">
      import {
        renderLoanForm,
        renderLoanStatus,
      } from "../../public/js/loans.js";
      import { renderReturnForm } from "../../public/js/returns.js";
      import { renderHistory } from "../../public/js/history.js";

      // Bridge existing buttons to module functions used in UI text/links
      window.loadLoanStatus = () => {
        // Hide search section if exists
        const searchSection = document.getElementById("searchSemuaBuku");
        if (searchSection) {
          searchSection.style.display = "none";
        }

        // Hide dashboard cards
        const dashboardCards = document.getElementById("dashboardCards");
        if (dashboardCards) {
          dashboardCards.style.display = "none";
        }

        const container = document.querySelector(".popular-books");
        const title = document.getElementById("sectionTitle");
        if (title) title.textContent = "Status Peminjaman";
        if (container) renderLoanStatus(container);
      };
      window.loadLoanHistory = () => {
        // Hide search section if exists
        const searchSection = document.getElementById("searchSemuaBuku");
        if (searchSection) {
          searchSection.style.display = "none";
        }

        // Hide dashboard cards
        const dashboardCards = document.getElementById("dashboardCards");
        if (dashboardCards) {
          dashboardCards.style.display = "none";
        }

        const container = document.querySelector(".popular-books");
        const title = document.getElementById("sectionTitle");
        if (title) title.textContent = "Riwayat Peminjaman";
        if (container) renderHistory(container);
      };

      // Alias for storage event listener
      window.loadHistory = window.loadLoanHistory;

      // Manual trigger function for immediate updates
      window.triggerLiveUpdate = function () {
        console.log("Manual live update triggered");
        try {
          loadUserData();
          const sectionTitle =
            document.getElementById("sectionTitle")?.textContent || "";
          console.log("Manual update - Current section:", sectionTitle);

          if (sectionTitle.includes("Status Peminjaman")) {
            if (typeof window.loadLoanStatus === "function")
              window.loadLoanStatus();
          } else if (sectionTitle.includes("Riwayat Peminjaman")) {
            if (typeof window.loadHistory === "function") window.loadHistory();
          }
          refreshDashboardCardsLive();
        } catch (err) {
          console.error("Error in manual update:", err);
        }
      };
    </script>
    <script type="module">
      import { renderAllBooks } from "../../public/js/books.js";

      // Initialize allBooksCache if not already defined
      if (typeof allBooksCache === "undefined") {
        window.allBooksCache = [];
      }

      // Functions moved to global scope above

      // Event listeners for dynamically created search elements will be handled in setupSearch() and setupSortHandlers()
    </script>
  </body>
</html>
