<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>E-Perpus - Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f5f6fa;
      }
      .sidebar {
        height: 100vh;
        background: #1e3d59;
        color: #fff;
        padding: 20px 10px;
        position: fixed;
        width: 220px;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .sidebar a:hover {
        background: #3a506b;
      }
      .content {
        margin-left: 240px;
        padding: 20px;
      }
      .card-info {
        border-radius: 12px;
        padding: 20px;
        color: #fff;
      }
      .card-blue {
        background: #007bff;
      }
      .card-orange {
        background: #ff8c42;
      }
      .card-green {
        background: #4caf50;
      }
      .card-red {
        background: #dc3545;
      }
      .card-purple {
        background: #6f42c1;
      }
      .hero {
        background: linear-gradient(
            135deg,
            rgba(30, 61, 89, 0.85),
            rgba(0, 123, 255, 0.75)
          ),
          url("https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop")
            center/cover no-repeat;
        border-radius: 16px;
        color: #fff;
        padding: 28px;
        min-height: 160px;
        display: flex;
        align-items: center;
      }
      .hero h4 {
        margin: 0 0 6px 0;
      }
      .hero p {
        margin: 0;
        opacity: 0.95;
      }
      .admin-section {
        display: none;
      }
      .admin-section.active {
        display: block;
      }
      .notification-item {
        border-left: 4px solid #dc3545;
        background: #fff3cd;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 4px;
      }
      .book-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
      }
      .book-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .book-img {
        height: 200px;
        object-fit: cover;
      }
      /* Recent activity scroll */
      #recentActivity {
        max-height: 320px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h4 class="text-center mb-4">ðŸ“š E-Library</h4>
      <h6 class="text-center mb-3 text-warning">Admin Panel</h6>

      <a
        href="#"
        onclick="showSection('home')"
        class="admin-menu-item"
        data-section="home"
      >
        <i class="fas fa-home me-2"></i>Home
      </a>
      <a
        href="#"
        onclick="showSection('profile')"
        class="admin-menu-item"
        data-section="profile"
      >
        <i class="fas fa-user-shield me-2"></i>Profile Admin
      </a>
      <a
        href="#"
        onclick="showSection('books')"
        class="admin-menu-item"
        data-section="books"
      >
        <i class="fas fa-book me-2"></i>Kelola Buku
      </a>
      <a
        href="#"
        onclick="showSection('users')"
        class="admin-menu-item"
        data-section="users"
      >
        <i class="fas fa-users me-2"></i>Kelola User
      </a>
      <a
        href="#"
        onclick="showSection('loans')"
        class="admin-menu-item"
        data-section="loans"
      >
        <i class="fas fa-book-reader me-2"></i>Kelola Peminjaman
      </a>
      <a
        href="#"
        onclick="showSection('reports')"
        class="admin-menu-item"
        data-section="reports"
      >
        <i class="fas fa-chart-bar me-2"></i>Laporan Peminjaman
      </a>
      <a
        href="#"
        onclick="showSection('payments')"
        class="admin-menu-item"
        data-section="payments"
      >
        <i class="fas fa-credit-card me-2"></i>Kelola Pembayaran
      </a>

      <hr class="my-3" />
      <a
        href="#"
        class="text-danger fw-bold"
        data-bs-toggle="modal"
        data-bs-target="#logoutModal"
      >
        <i class="fas fa-sign-out-alt me-2"></i>Logout
      </a>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 id="adminName">Halo, Admin ðŸ‘‹</h3>
        <div class="dropdown">
          <button
            class="btn btn-outline-secondary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <i class="fas fa-user-shield me-2"></i
            ><span id="adminDropdownName">Admin</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a
                class="dropdown-item"
                href="#"
                onclick="showSection('profile')"
              >
                <i class="fas fa-user-shield me-2"></i>Profile Admin
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" onclick="showAdminSettings()">
                <i class="fas fa-cog me-2"></i>Pengaturan
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-danger"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#logoutModal"
              >
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Home Section -->
      <div id="home-section" class="admin-section">
        <div class="hero mb-4">
          <div>
            <h4>Dashboard Admin E-Library</h4>
            <p>Kelola perpustakaan dengan mudah dan efisien.</p>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card-info card-blue">
              <h6><i class="fas fa-book me-2"></i>Total Buku</h6>
              <h3 id="totalBooks">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-info card-green">
              <h6><i class="fas fa-users me-2"></i>Total User</h6>
              <h3 id="totalUsers">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-info card-orange">
              <h6><i class="fas fa-book-reader me-2"></i>Peminjaman Aktif</h6>
              <h3 id="activeLoans">0</h3>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-info card-red">
              <h6>
                <i class="fas fa-exclamation-triangle me-2"></i>Keterlambatan
              </h6>
              <h3 id="overdueLoans">0</h3>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-bell me-2"></i>Notifikasi Penting
            </h5>
          </div>
          <div class="card-body">
            <div id="notificationsList">
              <!-- Notifications will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-history me-2"></i>Aktivitas Terbaru
            </h5>
          </div>
          <div class="card-body">
            <div id="recentActivity">
              <!-- Recent activity will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Admin Section -->
      <div id="profile-section" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="fas fa-user-shield me-2"></i>Profile Admin</h4>
          <button class="btn btn-primary" onclick="editProfile()">
            <i class="fas fa-edit me-2"></i>Edit Profile
          </button>
        </div>

        <!-- View Profile -->
        <div id="viewProfile">
          <div class="row">
            <div class="col-md-4">
              <div class="card">
                <div class="card-body text-center">
                  <div class="mb-3">
                    <i class="fas fa-user-shield fa-4x text-primary"></i>
                  </div>
                  <h5 id="profileName">Admin Perpustakaan</h5>
                  <p class="text-muted mb-1">
                    <strong>Role:</strong>
                    <span id="profileRole">Administrator</span>
                  </p>
                  <p class="text-muted mb-1">
                    <strong>Email:</strong>
                    <span id="profileEmail">admin@perpustakaan.com</span>
                  </p>
                  <p class="text-muted mb-1">
                    <strong>Username:</strong>
                    <span id="profileUsername">admin</span>
                  </p>
                  <div class="mt-3">
                    <span class="badge bg-success">Aktif</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">
                  <h6>
                    <i class="fas fa-info-circle me-2"></i>Informasi Detail
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Nama Lengkap:</strong></div>
                    <div class="col-sm-8" id="detailName">
                      Admin Perpustakaan
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Username:</strong></div>
                    <div class="col-sm-8" id="detailUsername">admin</div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Email:</strong></div>
                    <div class="col-sm-8" id="detailEmail">
                      admin@perpustakaan.com
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Role:</strong></div>
                    <div class="col-sm-8" id="detailRole">Administrator</div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4">
                      <strong>Tanggal Bergabung:</strong>
                    </div>
                    <div class="col-sm-8" id="detailJoinDate">
                      01 Januari 2024
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Terakhir Login:</strong></div>
                    <div class="col-sm-8" id="detailLastLogin">Hari ini</div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-sm-4"><strong>Status:</strong></div>
                    <div class="col-sm-8">
                      <span class="badge bg-success">Aktif</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Statistics -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h6><i class="fas fa-chart-line me-2"></i>Statistik Admin</h6>
                </div>
                <div class="card-body">
                  <div class="row text-center">
                    <div class="col-md-3">
                      <div class="border-end">
                        <h4 class="text-primary" id="adminTotalBooks">0</h4>
                        <p class="text-muted mb-0">Total Buku</p>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="border-end">
                        <h4 class="text-success" id="adminTotalUsers">0</h4>
                        <p class="text-muted mb-0">Total User</p>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="border-end">
                        <h4 class="text-warning" id="adminActiveLoans">0</h4>
                        <p class="text-muted mb-0">Peminjaman Aktif</p>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <h4 class="text-danger" id="adminOverdueLoans">0</h4>
                      <p class="text-muted mb-0">Keterlambatan</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit Profile Form -->
        <div id="editProfile" style="display: none">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-edit me-2"></i>Edit Profile Admin</h6>
            </div>
            <div class="card-body">
              <form id="editProfileForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editName" class="form-label"
                        >Nama Lengkap</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="editName"
                        name="nama"
                        value="Admin Perpustakaan"
                        required
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editUsername" class="form-label"
                        >Username</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="editUsername"
                        name="username"
                        value="admin"
                        required
                      />
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editEmail" class="form-label">Email</label>
                      <input
                        type="email"
                        class="form-control"
                        id="editEmail"
                        name="email"
                        value="admin@perpustakaan.com"
                        required
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editRole" class="form-label">Role</label>
                      <select
                        class="form-select"
                        id="editRole"
                        name="role"
                        disabled
                      >
                        <option value="admin" selected>Administrator</option>
                      </select>
                      <div class="form-text">Role tidak dapat diubah</div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="editPassword" class="form-label"
                        >Password Baru</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        id="editPassword"
                        name="password"
                        placeholder="Kosongkan jika tidak ingin mengubah"
                      />
                      <div class="form-text">Minimal 6 karakter</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="confirmPassword" class="form-label"
                        >Konfirmasi Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        id="confirmPassword"
                        name="confirmPassword"
                        placeholder="Konfirmasi password baru"
                      />
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="editBio" class="form-label">Bio</label>
                  <textarea
                    class="form-control"
                    id="editBio"
                    name="bio"
                    rows="3"
                    placeholder="Tuliskan bio singkat tentang diri Anda"
                  >
Administrator perpustakaan yang bertanggung jawab mengelola sistem perpustakaan digital.</textarea
                  >
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Simpan Perubahan
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="cancelEditProfile()"
                  >
                    <i class="fas fa-times me-2"></i>Batal
                  </button>
                </div>
              </form>
              <div id="profileMessage" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Books Management Section -->
      <div id="books-section" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="fas fa-book me-2"></i>Kelola Buku</h4>
          <button class="btn btn-primary" onclick="showAddBookModal()">
            <i class="fas fa-plus me-2"></i>Tambah Buku
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="bookSearch"
                placeholder="Cari buku..."
              />
              <button class="btn btn-outline-secondary" onclick="searchBooks()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="bookFilter">
              <option value="all">Semua Buku</option>
              <option value="available">Tersedia</option>
              <option value="unavailable">Tidak Tersedia</option>
            </select>
          </div>
        </div>

        <!-- Books Grid -->
        <div id="booksGrid" class="row">
          <!-- Books will be loaded here -->
        </div>
      </div>

      <!-- User Management Section -->
      <div id="users-section" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4><i class="fas fa-users me-2"></i>Kelola User</h4>
            <p class="text-muted mb-0">
              Kelola akun user, reset password, dan aktifkan/nonaktifkan user
            </p>
          </div>
          <button class="btn btn-success" onclick="showAddUserModal()">
            <i class="fas fa-user-plus me-2"></i>Tambah User
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="userSearch"
                placeholder="Cari user..."
              />
              <button class="btn btn-outline-secondary" onclick="searchUsers()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="userFilter">
              <option value="all">Semua User</option>
              <option value="active">Aktif</option>
              <option value="inactive">Tidak Aktif</option>
            </select>
          </div>
        </div>

        <!-- Users Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID User</th>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>Telepon</th>
                    <th>Status</th>
                    <th>Buku Dipinjam</th>
                    <th>Terdaftar</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Loan Management Section -->
      <div id="loans-section" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4><i class="fas fa-book-reader me-2"></i>Kelola Peminjaman</h4>
            <p class="text-muted mb-0">
              Kelola peminjaman aktif, konfirmasi pengembalian, dan pantau
              keterlambatan
            </p>
          </div>
        </div>

        <!-- Loan Management Tabs -->
        <ul class="nav nav-tabs mb-4" id="loanTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="active-loans-tab"
              data-bs-toggle="tab"
              data-bs-target="#active-loans"
              type="button"
              role="tab"
            >
              <i class="fas fa-list me-2"></i>Daftar Peminjaman Aktif
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="overdue-loans-tab"
              data-bs-toggle="tab"
              data-bs-target="#overdue-loans"
              type="button"
              role="tab"
            >
              <i class="fas fa-exclamation-triangle me-2"></i>Daftar
              Keterlambatan
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="return-confirm-tab"
              data-bs-toggle="tab"
              data-bs-target="#return-confirm"
              type="button"
              role="tab"
            >
              <i class="fas fa-check-circle me-2"></i>Konfirmasi Pengembalian
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="loanTabsContent">
          <!-- Active Loans Tab -->
          <div
            class="tab-pane fade show active"
            id="active-loans"
            role="tabpanel"
          >
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Peminjaman Aktif</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>ID Peminjaman</th>
                        <th>Buku</th>
                        <th>Peminjam</th>
                        <th>Tanggal Pinjam</th>
                        <th>Jatuh Tempo</th>
                        <th>Status</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="activeLoansTableBody">
                      <!-- Active loans will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Overdue Loans Tab -->
          <div class="tab-pane fade" id="overdue-loans" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Daftar Keterlambatan</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>ID Peminjaman</th>
                        <th>Buku</th>
                        <th>Peminjam</th>
                        <th>Tanggal Pinjam</th>
                        <th>Jatuh Tempo</th>
                        <th>Terlambat</th>
                        <th>Denda</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="overdueLoansTableBody">
                      <!-- Overdue loans will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Return Confirmation Tab -->
          <div class="tab-pane fade" id="return-confirm" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Konfirmasi Pengembalian</h6>
              </div>
              <div class="card-body">
                <form id="returnConfirmForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="returnLoanId" class="form-label"
                          >ID Peminjaman</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="returnLoanId"
                          name="returnLoanId"
                          placeholder="Masukkan ID peminjaman"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="returnBookId" class="form-label"
                          >ID Buku</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="returnBookId"
                          name="returnBookId"
                          placeholder="Masukkan ID buku"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="returnBorrowerName" class="form-label"
                          >Nama Peminjam</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="returnBorrowerName"
                          name="returnBorrowerName"
                          placeholder="Masukkan nama peminjam"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="returnCondition" class="form-label"
                          >Kondisi Buku</label
                        >
                        <select
                          class="form-select"
                          id="returnCondition"
                          name="returnCondition"
                        >
                          <option value="baik">Baik</option>
                          <option value="rusak_ringan">Rusak Ringan</option>
                          <option value="rusak_berat">Rusak Berat</option>
                          <option value="hilang">Hilang</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="returnNotes" class="form-label"
                      >Catatan (opsional)</label
                    >
                    <textarea
                      class="form-control"
                      id="returnNotes"
                      name="returnNotes"
                      rows="3"
                      placeholder="Catatan tambahan..."
                    ></textarea>
                  </div>
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-check me-2"></i>Konfirmasi Pengembalian
                  </button>
                </form>
                <div id="returnConfirmMessage" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Settings Section -->
      <div id="settings-section" class="admin-section">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-cog me-2"></i>Pengaturan Sistem
                </h5>
              </div>
              <div class="card-body">
                <form id="systemSettingsForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="libraryName" class="form-label"
                          >Nama Perpustakaan</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="libraryName"
                          value="E-Library"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="maxLoanDays" class="form-label"
                          >Maksimal Hari Peminjaman</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="maxLoanDays"
                          value="7"
                          min="1"
                          max="30"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="finePerDay" class="form-label"
                          >Denda per Hari (Rp)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="finePerDay"
                          value="1000"
                          min="0"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="maxBooksPerUser" class="form-label"
                          >Maksimal Buku per User</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="maxBooksPerUser"
                          value="5"
                          min="1"
                          max="10"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="autoRenewal" class="form-label"
                          >Perpanjangan Otomatis</label
                        >
                        <select class="form-select" id="autoRenewal">
                          <option value="enabled">Diaktifkan</option>
                          <option value="disabled">Dinonaktifkan</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="notificationDays" class="form-label"
                          >Notifikasi Sebelum Jatuh Tempo (hari)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="notificationDays"
                          value="2"
                          min="0"
                          max="7"
                        />
                      </div>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Simpan Pengaturan
                  </button>
                </form>
                <div id="settingsMessage" class="mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-2"></i>Informasi Sistem
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-3"><strong>Versi:</strong> 1.0.0</div>
                <div class="mb-3"><strong>Database:</strong> In-Memory</div>
                <div class="mb-3"><strong>Server:</strong> Node.js Express</div>
                <div class="mb-3">
                  <strong>Status:</strong>
                  <span class="badge bg-success">Aktif</span>
                </div>
                <hr />
                <div class="mb-2">
                  <strong>Statistik:</strong>
                </div>
                <div class="small text-muted">
                  <div>Total Buku: <span id="settingsTotalBooks">0</span></div>
                  <div>Total User: <span id="settingsTotalUsers">0</span></div>
                  <div>
                    Peminjaman Aktif: <span id="settingsActiveLoans">0</span>
                  </div>
                  <div>
                    Keterlambatan: <span id="settingsOverdueLoans">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports-section" class="admin-section">
        <h4 class="mb-4">
          <i class="fas fa-chart-bar me-2"></i>Laporan Peminjaman
        </h4>

        <!-- Report Filters -->
        <div class="row mb-4">
          <div class="col-md-3">
            <label class="form-label">Periode</label>
            <select
              class="form-select"
              id="reportPeriod"
              onchange="generateReport()"
            >
              <option value="today">Hari Ini</option>
              <option value="week">Minggu Ini</option>
              <option value="month">Bulan Ini</option>
              <option value="all">Semua</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select
              class="form-select"
              id="reportStatus"
              onchange="generateReport()"
            >
              <option value="all">Semua Status</option>
              <option value="active">Aktif</option>
              <option value="overdue">Terlambat</option>
              <option value="returned">Dikembalikan</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">User</label>
            <select
              class="form-select"
              id="reportUser"
              onchange="generateReport()"
            >
              <option value="all">Semua User</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" onclick="generateReport()">
              <i class="fas fa-filter me-2"></i>Filter Laporan
            </button>
          </div>
        </div>

        <!-- Additional Filters -->
        <div class="row mb-4">
          <div class="col-md-3">
            <label class="form-label">Dari Tanggal</label>
            <input
              type="date"
              class="form-control"
              id="reportFrom"
              onchange="generateReport()"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Sampai Tanggal</label>
            <input
              type="date"
              class="form-control"
              id="reportTo"
              onchange="generateReport()"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Kata Kunci</label>
            <input
              type="text"
              class="form-control"
              id="reportKeyword"
              placeholder="Cari judul, ID buku, nama peminjam..."
              oninput="generateReport()"
              onkeydown="if(event.key==='Enter'){event.preventDefault();generateReport();}"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button
              class="btn btn-outline-secondary w-100"
              onclick="printReport()"
            >
              <i class="fas fa-print me-2"></i>Cetak
            </button>
          </div>
        </div>

        <!-- Report Results -->
        <div id="reportResults">
          <!-- Report data will be loaded here -->
        </div>
      </div>

      <!-- Payments Section -->
      <div id="payments-section" class="admin-section">
        <h4 class="mb-4">
          <i class="fas fa-credit-card me-2"></i>Kelola Pembayaran
        </h4>

        <!-- Payment Filters -->
        <div class="row mb-4">
          <div class="col-md-3">
            <label class="form-label">Status Pembayaran</label>
            <select
              class="form-select"
              id="paymentStatus"
              onchange="loadPayments()"
            >
              <option value="all">Semua Status</option>
              <option value="completed">Selesai</option>
              <option value="pending">Pending</option>
              <option value="failed">Gagal</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Metode Pembayaran</label>
            <select
              class="form-select"
              id="paymentMethod"
              onchange="loadPayments()"
            >
              <option value="all">Semua Metode</option>
              <option value="cash">Tunai</option>
              <option value="transfer">Transfer Bank</option>
              <option value="qris">QRIS</option>
              <option value="e-wallet">E-Wallet</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Dari Tanggal</label>
            <input
              type="date"
              class="form-control"
              id="paymentFrom"
              onchange="loadPayments()"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Sampai Tanggal</label>
            <input
              type="date"
              class="form-control"
              id="paymentTo"
              onchange="loadPayments()"
            />
          </div>
        </div>

        <!-- Payment Summary Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Total Pembayaran</h6>
                    <h4 id="totalPayments">Rp 0</h4>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-credit-card fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Pembayaran Hari Ini</h6>
                    <h4 id="todayPayments">Rp 0</h4>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-calendar-day fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Denda Belum Dibayar</h6>
                    <h4 id="unpaidFines">Rp 0</h4>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="card-title">Jumlah Transaksi</h6>
                    <h4 id="totalTransactions">0</h4>
                  </div>
                  <div class="align-self-center">
                    <i class="fas fa-chart-line fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Results -->
        <div id="paymentResults">
          <!-- Payment data will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Logout Modal -->
    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Konfirmasi Logout</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Apakah Anda yakin ingin logout?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <a
              href="/"
              class="btn btn-danger"
              onclick="try{localStorage.clear()}catch(e){}"
              >Ya, Logout</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Add Book Modal -->
    <div
      class="modal fade"
      id="addBookModal"
      tabindex="-1"
      aria-labelledby="addBookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addBookModalLabel">Tambah Buku Baru</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addBookForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="bookId" class="form-label">ID Buku</label>
                    <input
                      type="text"
                      class="form-control"
                      id="bookId"
                      name="idBuku"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="bookTitle" class="form-label">Judul Buku</label>
                    <input
                      type="text"
                      class="form-control"
                      id="bookTitle"
                      name="namaBuku"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="bookAuthor" class="form-label">Penulis</label>
                    <input
                      type="text"
                      class="form-control"
                      id="bookAuthor"
                      name="penulis"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="bookPublisher" class="form-label"
                      >Penerbit</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="bookPublisher"
                      name="penerbit"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="bookYear" class="form-label"
                      >Tahun Terbit</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="bookYear"
                      name="tahunTerbit"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="bookStock" class="form-label">Stok</label>
                    <input
                      type="number"
                      class="form-control"
                      id="bookStock"
                      name="stok"
                      required
                      min="0"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="bookPhoto" class="form-label">Foto Buku</label>
                    <input
                      type="file"
                      class="form-control"
                      id="bookPhoto"
                      name="photo"
                      accept="image/*"
                    />
                    <div class="form-text">
                      Format: JPG, PNG. Nama file akan otomatis disesuaikan
                      dengan judul buku.
                    </div>
                    <div id="photoPreview" class="mt-2" style="display: none">
                      <img
                        id="previewImg"
                        src=""
                        alt="Preview"
                        class="img-thumbnail"
                        style="max-width: 200px; max-height: 200px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button type="button" class="btn btn-primary" onclick="addBook()">
              Tambah Buku
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Book Modal -->
    <div
      class="modal fade"
      id="editBookModal"
      tabindex="-1"
      aria-labelledby="editBookModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editBookModalLabel">Edit Buku</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editBookForm">
              <input type="hidden" id="editBookId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editBookTitle" class="form-label"
                      >Judul Buku</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editBookTitle"
                      name="namaBuku"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="editBookAuthor" class="form-label"
                      >Penulis</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editBookAuthor"
                      name="penulis"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="editBookPublisher" class="form-label"
                      >Penerbit</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editBookPublisher"
                      name="penerbit"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editBookYear" class="form-label"
                      >Tahun Terbit</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="editBookYear"
                      name="tahunTerbit"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="editBookStock" class="form-label">Stok</label>
                    <input
                      type="number"
                      class="form-control"
                      id="editBookStock"
                      name="stok"
                      required
                      min="0"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="editBookPhoto" class="form-label"
                      >Foto Buku</label
                    >
                    <input
                      type="file"
                      class="form-control"
                      id="editBookPhoto"
                      name="photo"
                      accept="image/*"
                    />
                    <div class="form-text">
                      Format: JPG, PNG. Kosongkan jika tidak ingin mengubah
                      foto.
                    </div>
                    <div
                      id="editPhotoPreview"
                      class="mt-2"
                      style="display: none"
                    >
                      <img
                        id="editPreviewImg"
                        src=""
                        alt="Preview"
                        class="img-thumbnail"
                        style="max-width: 200px; max-height: 200px"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateBook()"
            >
              Update Buku
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add User Modal -->
    <div
      class="modal fade"
      id="addUserModal"
      tabindex="-1"
      aria-labelledby="addUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Tambah User Baru</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addUserForm">
              <div class="mb-3">
                <label for="userName" class="form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="userName"
                  name="username"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="userEmail" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="userEmail"
                  name="email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="userPhone" class="form-label">Telepon</label>
                <input
                  type="text"
                  class="form-control"
                  id="userPhone"
                  name="telepon"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="userPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="userPassword"
                  name="password"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button type="button" class="btn btn-success" onclick="addUser()">
              Tambah User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div
      class="modal fade"
      id="editUserModal"
      tabindex="-1"
      aria-labelledby="editUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editUserForm">
              <input type="hidden" id="editUserId" />
              <div class="mb-3">
                <label for="editUserName" class="form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="editUserName"
                  name="username"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editUserEmail" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="editUserEmail"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editUserPhone" class="form-label">Telepon</label>
                <input
                  type="text"
                  class="form-control"
                  id="editUserPhone"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editUserPassword" class="form-label"
                  >Password Baru (kosongkan jika tidak ingin mengubah)</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="editUserPassword"
                  placeholder="Masukkan password baru"
                />
              </div>
              <div class="mb-3">
                <label for="editUserStatus" class="form-label">Status</label>
                <select class="form-select" id="editUserStatus">
                  <option value="active">Aktif</option>
                  <option value="inactive">Tidak Aktif</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateUser()"
            >
              Update User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteUserModal"
      tabindex="-1"
      aria-labelledby="deleteUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteUserModalLabel">
              Konfirmasi Hapus User
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Peringatan!</strong> Tindakan ini tidak dapat dibatalkan.
            </div>
            <p>
              Apakah Anda yakin ingin menghapus user
              <strong id="deleteUserName"></strong>?
            </p>
            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="confirmDelete"
                />
                <label class="form-check-label" for="confirmDelete">
                  Saya mengerti bahwa user akan dihapus secara permanen
                </label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirmDeleteBtn"
              onclick="confirmDeleteUser()"
              disabled
            >
              <i class="fas fa-trash me-2"></i>Hapus User
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // API Base URL
      const API_BASE = "http://localhost:3001/api";

      // Global variables
      let allBooks = [];
      let allUsers = [];
      let allLoans = [];
      let allReturns = [];
      let reportsInitialized = false; // prevent filters from resetting after user interaction

      // Show specific section
      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll(".admin-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Remove active class from all menu items
        document.querySelectorAll(".admin-menu-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Show selected section (guard if element not found)
        const targetSection = document.getElementById(sectionName + "-section");
        if (targetSection) {
          targetSection.classList.add("active");
        }

        // Add active class to selected menu item (guard if element not found)
        const targetMenuItem = document.querySelector(
          `[data-section="${sectionName}"]`
        );
        if (targetMenuItem) {
          targetMenuItem.classList.add("active");
        }

        // Load section-specific data
        switch (sectionName) {
          case "home":
            loadDashboardData();
            break;
          case "books":
            loadAllBooks();
            break;
          case "profile":
            loadProfileData();
            break;
          case "users":
            loadAllUsers();
            break;
          case "loans":
            loadLoanManagement();
            break;
          case "settings":
            loadSettings();
            break;
          case "reports":
            loadReports();
            break;
        }
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Load all data in parallel
          const [booksRes, usersRes, loansRes, returnsRes] = await Promise.all([
            fetch(`${API_BASE}/books`),
            fetch(`${API_BASE}/users`),
            fetch(`${API_BASE}/loans`),
            fetch(`${API_BASE}/returns`),
          ]);

          allBooks = await booksRes.json();
          allUsers = await usersRes.json();
          allLoans = await loansRes.json();
          allReturns = await returnsRes.json();

          // Update statistics
          document.getElementById("totalBooks").textContent = allBooks.length;
          const nonAdminUsersDash = allUsers.filter(
            (u) => String(u.role || "").toLowerCase() !== "admin"
          );
          document.getElementById("totalUsers").textContent =
            nonAdminUsersDash.length;
          const activeLoansCount = allLoans.filter(
            (loan) => loan.status === "aktif"
          ).length;
          document.getElementById("activeLoans").textContent = activeLoansCount;

          // Calculate overdue loans
          const today = new Date();
          const overdueCount = allLoans.filter((loan) => {
            const returnDate = new Date(loan.tanggalKembali);
            return returnDate < today && loan.status === "aktif";
          }).length;
          document.getElementById("overdueLoans").textContent = overdueCount;

          // Load notifications
          loadNotifications();
          loadRecentActivity();
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      // Load notifications
      function loadNotifications() {
        const notificationsList = document.getElementById("notificationsList");
        const today = new Date();

        const overdueLoans = allLoans.filter((loan) => {
          const returnDate = new Date(loan.tanggalKembali);
          return returnDate < today;
        });

        if (overdueLoans.length === 0) {
          notificationsList.innerHTML =
            '<div class="text-muted">Tidak ada notifikasi penting</div>';
          return;
        }

        let notificationsHTML = "";
        overdueLoans.forEach((loan) => {
          const book = allBooks.find((b) => b.idBuku === loan.idBuku);
          const daysOverdue = Math.ceil(
            (today - new Date(loan.tanggalKembali)) / (1000 * 60 * 60 * 24)
          );

          notificationsHTML += `
          <div class="notification-item">
            <strong>Peminjaman Terlambat</strong><br>
            <small>Buku: ${book ? book.namaBuku : "Tidak ditemukan"} (${
            loan.idBuku
          })</small><br>
            <small>Peminjam: ${
              loan.nama
            } - Terlambat ${daysOverdue} hari</small>
          </div>
        `;
        });

        notificationsList.innerHTML = notificationsHTML;
      }

      // Load recent activity
      function loadRecentActivity() {
        const recentActivity = document.getElementById("recentActivity");

        // Combine recent loans and returns
        const recentLoans = allLoans.slice(-5).map((loan) => ({
          ...loan,
          type: "loan",
          date: loan.tanggalPinjam,
        }));

        const recentReturns = allReturns.slice(-5).map((ret) => ({
          ...ret,
          type: "return",
          date: ret.tanggalPengembalian,
        }));

        const allActivities = [...recentLoans, ...recentReturns]
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 10);

        if (allActivities.length === 0) {
          recentActivity.innerHTML =
            '<div class="text-muted">Belum ada aktivitas</div>';
          return;
        }

        let activityHTML = "";
        allActivities.forEach((activity) => {
          const book = allBooks.find((b) => b.idBuku === activity.idBuku);
          const icon =
            activity.type === "loan"
              ? "fas fa-book-reader text-primary"
              : "fas fa-undo text-success";
          const action =
            activity.type === "loan" ? "Meminjam" : "Mengembalikan";

          activityHTML += `
          <div class="d-flex align-items-center mb-2">
            <i class="${icon} me-3"></i>
            <div>
              <small class="fw-bold">${activity.nama} ${action}</small><br>
              <small class="text-muted">${
                book ? book.namaBuku : "Buku tidak ditemukan"
              } - ${activity.date}</small>
            </div>
          </div>
        `;
        });

        recentActivity.innerHTML = activityHTML;
      }

      // Load loan management data
      async function loadLoanManagement() {
        try {
          console.log("Loading loan management data...");
          console.log("API_BASE:", API_BASE);

          const [loansRes, booksRes, usersRes] = await Promise.all([
            fetch(`${API_BASE}/loans`),
            fetch(`${API_BASE}/books`),
            fetch(`${API_BASE}/users`),
          ]);

          console.log("API responses status:", {
            loans: loansRes.status,
            books: booksRes.status,
            users: usersRes.status,
          });

          if (!loansRes.ok) {
            throw new Error(`Loans API failed: ${loansRes.status}`);
          }
          if (!booksRes.ok) {
            throw new Error(`Books API failed: ${booksRes.status}`);
          }
          if (!usersRes.ok) {
            throw new Error(`Users API failed: ${usersRes.status}`);
          }

          allLoans = await loansRes.json();
          allBooks = await booksRes.json();
          allUsers = await usersRes.json();

          console.log("Loaded data:", {
            loansCount: allLoans.length,
            booksCount: allBooks.length,
            usersCount: allUsers.length,
          });
          console.log("All loans data:", allLoans);

          loadActiveLoans();
          loadOverdueLoans();
        } catch (error) {
          console.error("Error loading loan management data:", error);
          // Show error in the table
          const activeLoansTableBody = document.getElementById(
            "activeLoansTableBody"
          );
          if (activeLoansTableBody) {
            activeLoansTableBody.innerHTML =
              '<tr><td colspan="7" class="text-center text-danger">Gagal memuat data peminjaman</td></tr>';
          }
        }
      }

      // Load active loans
      function loadActiveLoans() {
        console.log("All loans:", allLoans);

        // Try different status values in case of case sensitivity
        const activeLoans = allLoans.filter(
          (loan) => (loan.status || "").toLowerCase() === "aktif"
        );

        console.log("Active loans found:", activeLoans);

        const activeLoansTableBody = document.getElementById(
          "activeLoansTableBody"
        );

        if (!activeLoansTableBody) {
          console.error("activeLoansTableBody element not found!");
          return;
        }

        if (activeLoans.length === 0) {
          activeLoansTableBody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">Tidak ada peminjaman aktif</td></tr>';
          return;
        }

        let activeLoansHTML = "";
        activeLoans.forEach((loan) => {
          console.log("Processing loan:", loan);

          const book = allBooks.find((b) => b.idBuku === loan.idBuku);
          const user = allUsers.find((u) => u.id === loan.idUser);

          console.log("Found book:", book);
          console.log("Found user:", user);

          // Simple date comparison - just compare date strings
          const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD format
          const isOverdue = loan.tanggalKembali < today;
          const statusClass = isOverdue ? "danger" : "success";
          const statusText = isOverdue ? "Terlambat" : "Aktif";

          // Calculate days overdue if applicable
          let daysOverdue = 0;
          if (isOverdue) {
            const returnDate = new Date(loan.tanggalKembali);
            const todayDate = new Date();
            daysOverdue = Math.ceil(
              (todayDate - returnDate) / (1000 * 60 * 60 * 24)
            );
          }

          activeLoansHTML += `
          <tr class="${isOverdue ? "table-warning" : ""}">
            <td>${loan.id}</td>
            <td>${book ? book.namaBuku : "Buku tidak ditemukan"}</td>
            <td>${user ? user.nama : loan.nama}</td>
            <td>${loan.tanggalPinjam}</td>
            <td>${loan.tanggalKembali}${
            isOverdue
              ? ` <small class="text-danger">(${daysOverdue} hari terlambat)</small>`
              : ""
          }</td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>
              <button class="btn btn-sm btn-success" onclick="confirmReturn('${
                loan.id
              }')" title="Konfirmasi Pengembalian">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn btn-sm btn-info" onclick="viewLoanDetails('${
                loan.id
              }')" title="Detail Peminjaman">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
        });

        console.log("Generated HTML:", activeLoansHTML);
        activeLoansTableBody.innerHTML = activeLoansHTML;
      }

      // Load overdue loans
      function loadOverdueLoans() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day

        const overdueLoans = allLoans.filter((loan) => {
          if (loan.status !== "aktif") return false;
          const returnDate = new Date(loan.tanggalKembali);
          returnDate.setHours(0, 0, 0, 0); // Reset time to start of day
          return returnDate < today;
        });

        const overdueLoansTableBody = document.getElementById(
          "overdueLoansTableBody"
        );

        if (overdueLoans.length === 0) {
          overdueLoansTableBody.innerHTML =
            '<tr><td colspan="8" class="text-center text-muted">Tidak ada keterlambatan</td></tr>';
          return;
        }

        let overdueLoansHTML = "";
        overdueLoans.forEach((loan) => {
          const book = allBooks.find((b) => b.idBuku === loan.idBuku);
          const user = allUsers.find((u) => u.id === loan.idUser);
          const daysOverdue = Math.ceil(
            (today - new Date(loan.tanggalKembali)) / (1000 * 60 * 60 * 24)
          );
          const fine = daysOverdue * 1000; // Rp 1000 per hari

          overdueLoansHTML += `
          <tr class="table-danger">
            <td>${loan.id}</td>
            <td>${book ? book.namaBuku : "Buku tidak ditemukan"}</td>
            <td>${user ? user.nama : loan.nama}</td>
            <td>${loan.tanggalPinjam}</td>
            <td>${loan.tanggalKembali}</td>
            <td><span class="badge bg-danger">${daysOverdue} hari</span></td>
            <td><span class="text-danger fw-bold">Rp ${fine.toLocaleString()}</span></td>
            <td>
              <button class="btn btn-sm btn-success" onclick="confirmReturn('${
                loan.id
              }')" title="Konfirmasi Pengembalian">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn btn-sm btn-warning" onclick="sendReminder('${
                loan.id
              }')" title="Kirim Peringatan">
                <i class="fas fa-bell"></i>
              </button>
            </td>
          </tr>
        `;
        });

        overdueLoansTableBody.innerHTML = overdueLoansHTML;
      }

      // Show active loans tab
      function showActiveLoans() {
        const tab = new bootstrap.Tab(
          document.getElementById("active-loans-tab")
        );
        tab.show();
        loadActiveLoans();
      }

      // Show overdue loans tab
      function showOverdueLoans() {
        const tab = new bootstrap.Tab(
          document.getElementById("overdue-loans-tab")
        );
        tab.show();
        loadOverdueLoans();
      }

      // Confirm return
      function confirmReturn(loanId) {
        const loan = allLoans.find((l) => l.id === loanId);
        if (!loan) return;

        // Pre-fill the return confirmation form
        document.getElementById("returnLoanId").value = loan.id;
        document.getElementById("returnBookId").value = loan.idBuku;
        document.getElementById("returnBorrowerName").value = loan.nama;

        // Switch to return confirmation tab
        const tab = new bootstrap.Tab(
          document.getElementById("return-confirm-tab")
        );
        tab.show();
      }

      // View loan details
      function viewLoanDetails(loanId) {
        const loan = allLoans.find((l) => l.id === loanId);
        if (!loan) return;

        const book = allBooks.find((b) => b.idBuku === loan.idBuku);
        const user = allUsers.find((u) => u.id === loan.idUser);
        const isOverdue = new Date(loan.tanggalKembali) < new Date();
        const daysOverdue = isOverdue
          ? Math.ceil(
              (new Date() - new Date(loan.tanggalKembali)) /
                (1000 * 60 * 60 * 24)
            )
          : 0;
        const fine = daysOverdue * 1000;

        alert(`Detail Peminjaman:
ID Peminjaman: ${loan.id}
Buku: ${book ? book.namaBuku : "Tidak ditemukan"}
Peminjam: ${user ? user.nama : loan.nama}
Tanggal Pinjam: ${loan.tanggalPinjam}
Jatuh Tempo: ${loan.tanggalKembali}
Status: ${isOverdue ? "Terlambat" : "Aktif"}
${
  isOverdue
    ? `Terlambat: ${daysOverdue} hari\nDenda: Rp ${fine.toLocaleString()}`
    : ""
}`);
      }

      // Send reminder
      function sendReminder(loanId) {
        const loan = allLoans.find((l) => l.id === loanId);
        if (!loan) return;

        const book = allBooks.find((b) => b.idBuku === loan.idBuku);
        const user = allUsers.find((u) => u.id === loan.idUser);

        if (
          confirm(
            `Kirim peringatan kepada ${
              user ? user.nama : loan.nama
            } untuk mengembalikan buku "${
              book ? book.namaBuku : "Tidak ditemukan"
            }"?`
          )
        ) {
          alert("Peringatan telah dikirim!");
          // In a real application, this would send an email or notification
        }
      }

      // Load all users
      async function loadAllUsers() {
        try {
          const response = await fetch(`${API_BASE}/users`);
          allUsers = await response.json();
          displayUsers(allUsers);
        } catch (error) {
          console.error("Error loading users:", error);
          document.getElementById("usersTableBody").innerHTML =
            '<tr><td colspan="8" class="text-center text-danger">Gagal memuat data user</td></tr>';
        }
      }

      // Display users in table
      function displayUsers(users) {
        const usersTableBody = document.getElementById("usersTableBody");

        if (users.length === 0) {
          usersTableBody.innerHTML =
            '<tr><td colspan="8" class="text-center text-muted">Tidak ada user ditemukan</td></tr>';
          return;
        }

        let usersHTML = "";
        const showAdmins = false; // hide admin rows from user management list
        users
          .filter((u) =>
            showAdmins ? true : String(u.role || "").toLowerCase() !== "admin"
          )
          .forEach((user) => {
            const activeLoans = allLoans.filter(
              (loan) => loan.idUser === user.id && loan.status === "aktif"
            ).length;
            const statusClass = user.status === "active" ? "success" : "danger";
            const statusText =
              user.status === "active" ? "Aktif" : "Tidak Aktif";

            usersHTML += `
          <tr class="${user.status === "inactive" ? "table-secondary" : ""}">
            <td>${user.id}</td>
            <td>${user.nama} ${
              user.status === "inactive"
                ? '<i class="fas fa-user-slash text-muted ms-1" title="User Tidak Aktif"></i>'
                : ""
            }</td>
            <td>${user.email}</td>
            <td>${user.telepon}</td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>${activeLoans}</td>
            <td>${
              user.createdAt
                ? new Date(user.createdAt).toLocaleDateString("id-ID", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
                : "N/A"
            }</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="editUser('${
                  user.id
                }')" title="Edit User">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="resetPassword('${
                  user.id
                }')" title="Reset Password">
                  <i class="fas fa-key"></i>
                </button>
                <button class="btn btn-outline-${
                  user.status === "active" ? "danger" : "success"
                }" 
                        onclick="toggleUserStatus('${user.id}')" 
                        title="${
                          user.status === "active"
                            ? "Nonaktifkan User"
                            : "Aktifkan User"
                        }"
                        style="min-width: 40px;">
                  <i class="fas fa-${
                    user.status === "active" ? "ban" : "check"
                  }"></i>
                </button>
                <button class="btn btn-outline-danger" 
                        onclick="deleteUser('${user.id}')" 
                        title="Hapus User">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
          });

        usersTableBody.innerHTML = usersHTML;
      }

      // Search users
      function searchUsers() {
        const searchTerm = document
          .getElementById("userSearch")
          .value.toLowerCase();
        const filter = document.getElementById("userFilter").value;

        let filteredUsers = allUsers.filter(
          (user) =>
            user.nama.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.id.toLowerCase().includes(searchTerm)
        );

        if (filter === "active") {
          filteredUsers = filteredUsers.filter(
            (user) => user.status === "active"
          );
        } else if (filter === "inactive") {
          filteredUsers = filteredUsers.filter(
            (user) => user.status === "inactive"
          );
        }

        displayUsers(filteredUsers);
      }

      // Show add user modal
      function showAddUserModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("addUserModal")
        );
        modal.show();
      }

      // Add new user
      async function addUser() {
        const form = document.getElementById("addUserForm");
        const formData = new FormData(form);
        const userData = Object.fromEntries(formData.entries());

        try {
          const response = await fetch(`${API_BASE}/users`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          if (response.ok) {
            alert("User berhasil ditambahkan");
            bootstrap.Modal.getInstance(
              document.getElementById("addUserModal")
            ).hide();
            form.reset();
            loadAllUsers();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Edit user
      function editUser(userId) {
        const user = allUsers.find((u) => u.id === userId);
        if (!user) return;

        document.getElementById("editUserId").value = user.id;
        document.getElementById("editUserName").value =
          user.username || user.nama;
        document.getElementById("editUserEmail").value = user.email;
        document.getElementById("editUserPhone").value = user.telepon;
        document.getElementById("editUserStatus").value =
          user.status || "active";

        const modal = new bootstrap.Modal(
          document.getElementById("editUserModal")
        );
        modal.show();
      }

      // Update user
      async function updateUser() {
        const userId = document.getElementById("editUserId").value;
        const form = document.getElementById("editUserForm");
        const formData = new FormData(form);
        const userData = Object.fromEntries(formData.entries());

        try {
          const response = await fetch(`${API_BASE}/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          if (response.ok) {
            alert("User berhasil diupdate");
            bootstrap.Modal.getInstance(
              document.getElementById("editUserModal")
            ).hide();
            loadAllUsers();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Reset password
      async function resetPassword(userId) {
        const newPassword = prompt("Masukkan password baru:");
        if (!newPassword) return;

        try {
          const response = await fetch(
            `${API_BASE}/users/${userId}/reset-password`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ password: newPassword }),
            }
          );

          if (response.ok) {
            alert("Password berhasil direset");
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Toggle user status
      async function toggleUserStatus(userId) {
        const user = allUsers.find((u) => u.id === userId);
        if (!user) return;

        const newStatus = user.status === "active" ? "inactive" : "active";
        const action =
          newStatus === "active" ? "mengaktifkan" : "menonaktifkan";

        if (!confirm(`Apakah Anda yakin ingin ${action} user ini?`)) return;

        try {
          const response = await fetch(`${API_BASE}/users/${userId}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ status: newStatus }),
          });

          if (response.ok) {
            alert(`User berhasil ${action}`);
            loadAllUsers();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Delete user
      function deleteUser(userId) {
        const user = allUsers.find((u) => u.id === userId);
        if (!user) return;

        // Check if user has active loans
        const activeLoans = allLoans.filter(
          (loan) => loan.idUser === userId && loan.status === "aktif"
        );
        if (activeLoans.length > 0) {
          alert(
            `Tidak dapat menghapus user karena masih memiliki ${activeLoans.length} peminjaman aktif. Silakan kembalikan buku terlebih dahulu.`
          );
          return;
        }

        // Show confirmation modal
        document.getElementById("deleteUserName").textContent = user.nama;
        document.getElementById("confirmDelete").checked = false;
        document.getElementById("confirmDeleteBtn").disabled = true;

        // Store userId for deletion
        window.userToDelete = userId;

        const modal = new bootstrap.Modal(
          document.getElementById("deleteUserModal")
        );
        modal.show();
      }

      // Confirm delete user
      async function confirmDeleteUser() {
        const userId = window.userToDelete;

        try {
          const response = await fetch(`${API_BASE}/users/${userId}`, {
            method: "DELETE",
          });

          if (response.ok) {
            alert("User berhasil dihapus");
            bootstrap.Modal.getInstance(
              document.getElementById("deleteUserModal")
            ).hide();
            loadAllUsers();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Load all books
      async function loadAllBooks() {
        try {
          const response = await fetch(`${API_BASE}/books`);
          allBooks = await response.json();
          // Apply current filter instead of showing all books
          searchBooks();
        } catch (error) {
          console.error("Error loading books:", error);
          document.getElementById("booksGrid").innerHTML =
            '<div class="col-12 text-center text-danger">Gagal memuat data buku</div>';
        }
      }

      // Display books in grid
      function displayBooks(books) {
        const booksGrid = document.getElementById("booksGrid");

        if (books.length === 0) {
          booksGrid.innerHTML =
            '<div class="col-12 text-center text-muted">Tidak ada buku ditemukan</div>';
          return;
        }

        // Helpers to resolve book image filenames (match user page logic)
        function sanitizeForFilename(str) {
          return (str || "")
            .toString()
            .normalize("NFKD")
            .replace(/[^\w\s-]/g, "")
            .trim()
            .replace(/[\s_]+/g, "-")
            .toLowerCase();
        }
        window._tryBookImage = function (imgEl) {
          const title = imgEl.getAttribute("data-title") || "";
          const sanitized = sanitizeForFilename(title);
          const candidates = [
            `/images/${sanitized}.jpg`,
            `/images/${sanitized}.jpeg`,
            `/images/${sanitized}.png`,
            `/images/${title}.jpg`,
            `/images/${title}.jpeg`,
            `/images/${title}.png`,
          ];
          let idx = parseInt(imgEl.getAttribute("data-idx") || "0", 10);
          if (idx >= candidates.length) {
            imgEl.onerror = null;
            imgEl.src = "https://via.placeholder.com/300x200?text=No+Image";
            return;
          }
          const src = candidates[idx++];
          imgEl.setAttribute("data-idx", String(idx));
          // encode only the filename portion for spaces/non-ascii
          const parts = src.split("/");
          parts[parts.length - 1] = encodeURIComponent(parts[parts.length - 1]);
          imgEl.src = parts.join("/");
        };

        let booksHTML = "";
        books.forEach((book) => {
          booksHTML += `
          <div class="col-md-3 mb-3">
            <div class="card book-card">
              <img 
                   class="card-img-top book-img" 
                   alt="${book.namaBuku}"
                   data-title="${book.namaBuku}"
                   data-idx="0"
                   onerror="window._tryBookImage(this)"
                   src="/images/${sanitizeForFilename(book.namaBuku)}.jpg">
              <div class="card-body">
                <h6 class="card-title">${book.namaBuku}</h6>
                <p class="card-text">
                  <small class="text-muted">${book.penulis}</small><br>
                  <small class="text-info">${book.penerbit} (${
            book.tahunTerbit
          })</small><br>
                  <span class="badge ${
                    book.stok > 0 ? "bg-success" : "bg-danger"
                  }">
                    Stok: ${book.stok}
                  </span>
                </p>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-primary" onclick="editBook('${
                    book.idBuku
                  }')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteBook('${
                    book.idBuku
                  }')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        });

        booksGrid.innerHTML = booksHTML;
      }

      // Search books
      function searchBooks() {
        const searchTerm = document
          .getElementById("bookSearch")
          .value.toLowerCase();
        const filter = document.getElementById("bookFilter").value;

        let filteredBooks = allBooks.filter(
          (book) =>
            book.namaBuku.toLowerCase().includes(searchTerm) ||
            book.penulis.toLowerCase().includes(searchTerm) ||
            book.penerbit.toLowerCase().includes(searchTerm) ||
            book.idBuku.toLowerCase().includes(searchTerm)
        );

        if (filter === "available") {
          filteredBooks = filteredBooks.filter((book) => book.stok > 0);
        } else if (filter === "unavailable") {
          filteredBooks = filteredBooks.filter((book) => book.stok === 0);
        }

        displayBooks(filteredBooks);
      }

      // Show add book modal
      function showAddBookModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("addBookModal")
        );
        modal.show();

        // Reset photo preview
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("bookPhoto").value = "";
      }

      // Photo preview functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Add book photo preview
        const photoInput = document.getElementById("bookPhoto");
        const photoPreview = document.getElementById("photoPreview");
        const previewImg = document.getElementById("previewImg");

        if (photoInput) {
          photoInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                previewImg.src = e.target.result;
                photoPreview.style.display = "block";
              };
              reader.readAsDataURL(file);
            } else {
              photoPreview.style.display = "none";
            }
          });
        }

        // Edit book photo preview
        const editPhotoInput = document.getElementById("editBookPhoto");
        const editPhotoPreview = document.getElementById("editPhotoPreview");
        const editPreviewImg = document.getElementById("editPreviewImg");

        if (editPhotoInput) {
          editPhotoInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                editPreviewImg.src = e.target.result;
                editPhotoPreview.style.display = "block";
              };
              reader.readAsDataURL(file);
            } else {
              editPhotoPreview.style.display = "none";
            }
          });
        }
      });

      // Add new book
      async function addBook() {
        const form = document.getElementById("addBookForm");
        const formData = new FormData(form);
        // also append sanitized filename so backend can rename properly
        const title = (formData.get("namaBuku") || "").toString();
        const sanitized = title
          .normalize("NFKD")
          .replace(/[^\w\s-]/g, "")
          .trim()
          .replace(/[\s_]+/g, "-")
          .toLowerCase();
        if (sanitized) {
          const file = formData.get("photo");
          if (file && typeof file === "object") {
            const ext =
              file.name && file.name.split(".").pop()
                ? "." + file.name.split(".").pop()
                : ".jpg";
            formData.append("filename", `${sanitized}${ext}`);
          }
        }

        try {
          const response = await fetch(`${API_BASE}/books`, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            alert("Buku berhasil ditambahkan");
            bootstrap.Modal.getInstance(
              document.getElementById("addBookModal")
            ).hide();
            form.reset();
            loadAllBooks();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Edit book
      function editBook(bookId) {
        const book = allBooks.find((b) => b.idBuku === bookId);
        if (!book) return;

        document.getElementById("editBookId").value = book.idBuku;
        document.getElementById("editBookTitle").value = book.namaBuku;
        document.getElementById("editBookAuthor").value = book.penulis;
        document.getElementById("editBookPublisher").value = book.penerbit;
        document.getElementById("editBookYear").value = book.tahunTerbit;
        document.getElementById("editBookStock").value = book.stok;

        // Reset photo preview and file input
        document.getElementById("editPhotoPreview").style.display = "none";
        document.getElementById("editBookPhoto").value = "";

        const modal = new bootstrap.Modal(
          document.getElementById("editBookModal")
        );
        modal.show();
      }

      // Update book
      async function updateBook() {
        const bookId = document.getElementById("editBookId").value;
        const form = document.getElementById("editBookForm");
        const formData = new FormData(form);
        const bookData = Object.fromEntries(formData.entries());

        // Handle photo upload
        const photoFile = document.getElementById("editBookPhoto").files[0];
        if (photoFile) {
          // Generate filename based on book title
          const filename =
            bookData.namaBuku.toLowerCase().replace(/\s+/g, "") + ".jpg";
          bookData.photoFilename = filename;
        }

        try {
          // First, update the book data
          const response = await fetch(`${API_BASE}/books/${bookId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(bookData),
          });

          if (response.ok && photoFile) {
            // Then upload the photo
            const photoFormData = new FormData();
            photoFormData.append("photo", photoFile);
            photoFormData.append("filename", bookData.photoFilename);

            try {
              const photoResponse = await fetch(
                `${API_BASE}/books/upload-photo`,
                {
                  method: "POST",
                  body: photoFormData,
                }
              );

              if (!photoResponse.ok) {
                console.warn("Photo upload failed, but book was updated");
              }
            } catch (photoError) {
              console.warn("Photo upload error:", photoError);
            }
          }

          if (response.ok) {
            alert("Buku berhasil diupdate");
            bootstrap.Modal.getInstance(
              document.getElementById("editBookModal")
            ).hide();
            loadAllBooks();
            if (typeof loadDashboardData === "function") loadDashboardData();
            if (typeof loadSettings === "function") loadSettings();
            try {
              const timestamp = String(Date.now());
              localStorage.setItem("books:updated", timestamp);
              localStorage.setItem("loans:updated", timestamp);
              console.log("Admin triggered book/loan updates:", timestamp);
            } catch (e) {
              console.error("Failed to trigger updates:", e);
            }
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Delete book
      async function deleteBook(bookId) {
        if (!confirm("Apakah Anda yakin ingin menghapus buku ini?")) return;

        try {
          const response = await fetch(`${API_BASE}/books/${bookId}`, {
            method: "DELETE",
          });

          if (response.ok) {
            alert("Buku berhasil dihapus");
            loadAllBooks();
          } else {
            const error = await response.json();
            alert("Error: " + error.message);
          }
        } catch (error) {
          alert("Terjadi kesalahan: " + error.message);
        }
      }

      // Load reports
      async function loadReports() {
        try {
          // Preserve current selections if already initialized
          const prev = reportsInitialized
            ? {
                period: document.getElementById("reportPeriod")?.value,
                status: document.getElementById("reportStatus")?.value,
                user: document.getElementById("reportUser")?.value,
                from: document.getElementById("reportFrom")?.value,
                to: document.getElementById("reportTo")?.value,
                keyword: document.getElementById("reportKeyword")?.value,
              }
            : null;

          const [loansRes, returnsRes, booksRes, usersRes] = await Promise.all([
            fetch(`${API_BASE}/loans`),
            fetch(`${API_BASE}/returns`),
            fetch(`${API_BASE}/books`),
            fetch(`${API_BASE}/users`),
          ]);

          allLoans = await loansRes.json();
          allReturns = await returnsRes.json();
          allBooks = await booksRes.json();
          allUsers = await usersRes.json();

          // Populate user filter (rebuild options but keep current selection if any)
          const userSelect = document.getElementById("reportUser");
          if (userSelect) {
            const wanted = prev?.user || "all";
            userSelect.innerHTML = '<option value="all">Semua User</option>';
            allUsers
              .filter((u) => String(u.role || "").toLowerCase() !== "admin")
              .forEach((user) => {
                userSelect.innerHTML += `<option value="${user.id}">${user.nama}</option>`;
              });
            userSelect.value = wanted;
          }

          // On first load, set defaults; otherwise restore previous selections
          const periodSel = document.getElementById("reportPeriod");
          const statusSel = document.getElementById("reportStatus");
          if (!reportsInitialized) {
            if (periodSel) periodSel.value = "all";
            if (statusSel) statusSel.value = "all";
            if (userSelect) userSelect.value = "all";
            reportsInitialized = true;
          } else if (prev) {
            if (periodSel && prev.period) periodSel.value = prev.period;
            if (statusSel && prev.status) statusSel.value = prev.status;
            if (document.getElementById("reportFrom"))
              document.getElementById("reportFrom").value = prev.from || "";
            if (document.getElementById("reportTo"))
              document.getElementById("reportTo").value = prev.to || "";
            if (document.getElementById("reportKeyword"))
              document.getElementById("reportKeyword").value =
                prev.keyword || "";
          }

          generateReport();
        } catch (error) {
          console.error("Error loading reports:", error);
        }
      }

      // Generate report
      function generateReport() {
        const period = document.getElementById("reportPeriod").value;
        const status = document.getElementById("reportStatus").value;
        const userId = document.getElementById("reportUser").value;
        const fromVal = document.getElementById("reportFrom").value;
        const toVal = document.getElementById("reportTo").value;
        const keyword = (document.getElementById("reportKeyword").value || "")
          .toLowerCase()
          .trim();

        let reportData = [...allLoans, ...allReturns];

        // Filter by period
        if (period !== "all") {
          const today = new Date();
          let startDate;

          switch (period) {
            case "today":
              startDate = new Date(
                today.getFullYear(),
                today.getMonth(),
                today.getDate()
              );
              break;
            case "week":
              startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
              break;
            case "month":
              startDate = new Date(today.getFullYear(), today.getMonth(), 1);
              break;
          }

          if (startDate) {
            reportData = reportData.filter(
              (item) =>
                new Date(item.tanggalPinjam || item.tanggalPengembalian) >=
                startDate
            );
          }
        }

        // Filter by status
        if (status !== "all") {
          if (status === "active") {
            reportData = reportData.filter((item) => item.status === "aktif");
          } else if (status === "overdue") {
            const today = new Date();
            reportData = reportData.filter((item) => {
              const returnDate = new Date(item.tanggalKembali);
              return returnDate < today && item.status === "aktif";
            });
          } else if (status === "returned") {
            reportData = reportData.filter(
              (item) =>
                item.status === "selesai" || item.status === "dikembalikan"
            );
          }
        }

        // Filter by user
        if (userId !== "all") {
          reportData = reportData.filter((item) => item.idUser === userId);
        }

        // Filter by date range (overrides/combines with period)
        if (fromVal) {
          const fromDate = new Date(fromVal);
          reportData = reportData.filter(
            (item) =>
              new Date(item.tanggalPinjam || item.tanggalPengembalian) >=
              fromDate
          );
        }
        if (toVal) {
          const toDate = new Date(toVal);
          // include end date by setting time to end of day
          toDate.setHours(23, 59, 59, 999);
          reportData = reportData.filter(
            (item) =>
              new Date(item.tanggalPinjam || item.tanggalPengembalian) <= toDate
          );
        }

        // Keyword filter (by book title, idBuku, borrower name)
        if (keyword) {
          reportData = reportData.filter((item) => {
            const book = allBooks.find((b) => b.idBuku === item.idBuku);
            const title = (book?.namaBuku || "").toLowerCase();
            const idBuku = (item.idBuku || "").toLowerCase();
            const nama = (item.nama || "").toLowerCase();
            return (
              title.includes(keyword) ||
              idBuku.includes(keyword) ||
              nama.includes(keyword)
            );
          });
        }

        displayReport(reportData);
      }

      // Print current report results
      function printReport() {
        const container = document.getElementById("reportResults");
        const period = document.getElementById("reportPeriod").value;
        const status = document.getElementById("reportStatus").value;
        const userId = document.getElementById("reportUser").value;
        const fromVal = document.getElementById("reportFrom").value;
        const toVal = document.getElementById("reportTo").value;
        const keyword = document.getElementById("reportKeyword").value;

        const userName =
          userId !== "all"
            ? allUsers.find((u) => u.id === userId)?.nama || userId
            : "Semua User";

        const w = window.open("", "_blank");
        if (!w) return;
        w.document
          .write(`<!DOCTYPE html><html><head><title>Cetak Laporan</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>body{padding:20px} .meta small{display:block} @media print { .no-print{display:none} }
        table{font-size:12px}</style></head><body>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Laporan Peminjaman</h5>
          <button class="btn btn-sm btn-secondary no-print" onclick="window.print()">Print</button>
        </div>
        <div class="meta mb-3">
          <small><strong>Periode:</strong> ${period}</small>
          <small><strong>Status:</strong> ${status}</small>
          <small><strong>User:</strong> ${userName}</small>
          <small><strong>Dari:</strong> ${
            fromVal || "-"
          } &nbsp; <strong>Sampai:</strong> ${toVal || "-"}</small>
          <small><strong>Kata Kunci:</strong> ${keyword || "-"}</small>
          <small><strong>Dicetak:</strong> ${new Date().toLocaleString()}</small>
        </div>
        ${container.innerHTML}
      </body></html>`);
        w.document.close();
        w.focus();
        try {
          w.print();
        } catch (_) {}
      }

      // Display report
      function displayReport(data) {
        const reportResults = document.getElementById("reportResults");

        // Summary metrics based on master data
        const totalBooks = allBooks.length;
        const totalBookStock = allBooks.reduce(
          (sum, b) => sum + (parseInt(b.stok) || 0),
          0
        );
        const totalUsers = allUsers.length;
        const activeLoansCount = allLoans.filter(
          (l) => l.status === "aktif"
        ).length;
        const overdueLoansCount = allLoans.filter(
          (l) => l.status === "aktif" && new Date(l.tanggalKembali) < new Date()
        ).length;
        const totalReturns = allReturns.length;
        const totalFines = allReturns.reduce(
          (sum, r) => sum + (parseInt(r.denda) || 0),
          0
        );

        let reportHTML = `
        <div class="card mb-3">
          <div class="card-header">
            <h6 class="mb-0">Ringkasan Sistem</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Metrix</th>
                    <th>Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>Total Buku</td><td>${totalBooks}</td></tr>
                  <tr><td>Total Stok Buku</td><td>${totalBookStock}</td></tr>
                  <tr><td>Total User</td><td>${totalUsers}</td></tr>
                  <tr><td>Peminjaman Aktif</td><td>${activeLoansCount}</td></tr>
                  <tr><td>Keterlambatan</td><td>${overdueLoansCount}</td></tr>
                  <tr><td>Total Pengembalian</td><td>${totalReturns}</td></tr>
                  <tr><td>Total Denda (riwayat)</td><td>Rp ${totalFines.toLocaleString()}</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

        // Detailed table (based on current filters)
        reportHTML += `
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Laporan Peminjaman (${data.length} data)</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID Buku</th>
                    <th>Judul Buku</th>
                    <th>Peminjam</th>
                    <th>Tanggal Pinjam</th>
                    <th>Tanggal Kembali</th>
                    <th>Status</th>
                    <th>Denda</th>
                  </tr>
                </thead>
                <tbody>
      `;

        data.forEach((item) => {
          const book = allBooks.find((b) => b.idBuku === item.idBuku);
          const isOverdue =
            item.status === "aktif" &&
            new Date(item.tanggalKembali) < new Date();
          const statusClass =
            item.status === "aktif"
              ? isOverdue
                ? "text-danger"
                : "text-success"
              : "text-muted";
          const statusText =
            item.status === "aktif"
              ? isOverdue
                ? "Terlambat"
                : "Aktif"
              : "Selesai";

          reportHTML += `
          <tr>
            <td>${item.idBuku}</td>
            <td>${book ? book.namaBuku : "Tidak ditemukan"}</td>
            <td>${item.nama}</td>
            <td>${item.tanggalPinjam}</td>
            <td>${item.tanggalKembali || item.tanggalPengembalian || "-"}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${item.denda ? "Rp " + item.denda.toLocaleString() : "-"}</td>
          </tr>
        `;
        });

        reportHTML += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

        if (data.length === 0) {
          reportHTML += `<tr><td colspan="7" class="text-center text-muted">Tidak ada data untuk ditampilkan</td></tr>`;
        }

        // Books listing (filtered by keyword if provided)
        const kw = (document.getElementById("reportKeyword")?.value || "")
          .toLowerCase()
          .trim();
        const filteredBooks = kw
          ? allBooks.filter(
              (b) =>
                (b.idBuku || "").toLowerCase().includes(kw) ||
                (b.namaBuku || "").toLowerCase().includes(kw) ||
                (b.penulis || "").toLowerCase().includes(kw) ||
                (b.penerbit || "").toLowerCase().includes(kw)
            )
          : allBooks;

        reportHTML += `
        <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Daftar Data Buku (${
              filteredBooks.length
            } buku)</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>ID Buku</th>
                    <th>Judul</th>
                    <th>Penulis</th>
                    <th>Penerbit</th>
                    <th>Tahun</th>
                    <th>Stok</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    filteredBooks.length === 0
                      ? '<tr><td colspan="6" class="text-center text-muted">Tidak ada buku</td></tr>'
                      : ""
                  }
                  ${filteredBooks
                    .map(
                      (b) => `
                    <tr>
                      <td>${b.idBuku}</td>
                      <td>${b.namaBuku}</td>
                      <td>${b.penulis}</td>
                      <td>${b.penerbit}</td>
                      <td>${b.tahunTerbit}</td>
                      <td>${b.stok}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

        reportResults.innerHTML = reportHTML;
      }

      // Load settings
      async function loadSettings() {
        try {
          // Load system statistics
          const [booksRes, usersRes, loansRes] = await Promise.all([
            fetch(`${API_BASE}/books`),
            fetch(`${API_BASE}/users`),
            fetch(`${API_BASE}/loans`),
          ]);

          const books = await booksRes.json();
          const users = await usersRes.json();
          const loans = await loansRes.json();

          // Update statistics (exclude admin accounts from user count)
          document.getElementById("settingsTotalBooks").textContent =
            books.length;
          const nonAdminUsers = users.filter(
            (u) => String(u.role || "").toLowerCase() !== "admin"
          );
          document.getElementById("settingsTotalUsers").textContent =
            nonAdminUsers.length;
          const activeCount = loans.filter(
            (l) => (l.status || "").toLowerCase() === "aktif"
          ).length;
          document.getElementById("settingsActiveLoans").textContent =
            activeCount;

          // Calculate overdue loans
          const today = new Date();
          const overdueCount = loans.filter((loan) => {
            const returnDate = new Date(loan.tanggalKembali);
            return returnDate < today && loan.status === "aktif";
          }).length;
          document.getElementById("settingsOverdueLoans").textContent =
            overdueCount;

          // Load settings from server and populate form
          try {
            const settingsRes = await fetch(`${API_BASE}/admin/settings`);
            if (settingsRes.ok) {
              const settings = await settingsRes.json();
              localStorage.setItem("systemSettings", JSON.stringify(settings));
            }
          } catch (e) {
            /* ignore, fallback to localStorage */
          }

          loadSystemSettings();
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      // Load system settings
      function loadSystemSettings() {
        const settings = JSON.parse(
          localStorage.getItem("systemSettings") || "{}"
        );

        document.getElementById("libraryName").value =
          settings.libraryName ?? "E-Library";
        document.getElementById("maxLoanDays").value =
          settings.maxLoanDays ?? 7;
        document.getElementById("finePerDay").value =
          settings.finePerDay ?? 1000;
        document.getElementById("maxBooksPerUser").value =
          settings.maxBooksPerUser ?? 5;
        document.getElementById("autoRenewal").value =
          settings.autoRenewal ?? "disabled";
        document.getElementById("notificationDays").value =
          settings.notificationDays ?? 2;

        // Reflect library name in sidebar on load
        const sidebarTitle = document.querySelector(".sidebar h4");
        if (sidebarTitle && (settings.libraryName ?? "").trim()) {
          sidebarTitle.textContent = `ðŸ“š ${settings.libraryName}`;
        }
      }

      // Save system settings
      function saveSystemSettings() {
        const settings = {
          libraryName: document.getElementById("libraryName").value,
          maxLoanDays: parseInt(document.getElementById("maxLoanDays").value),
          finePerDay: parseInt(document.getElementById("finePerDay").value),
          maxBooksPerUser: parseInt(
            document.getElementById("maxBooksPerUser").value
          ),
          autoRenewal: document.getElementById("autoRenewal").value,
          notificationDays: parseInt(
            document.getElementById("notificationDays").value
          ),
        };

        localStorage.setItem("systemSettings", JSON.stringify(settings));

        // Update library name in sidebar
        const sidebarTitle = document.querySelector(".sidebar h4");
        if (sidebarTitle) {
          sidebarTitle.textContent = `ðŸ“š ${settings.libraryName}`;
        }

        return settings;
      }

      // Load profile data
      async function loadProfileData() {
        try {
          // Load admin statistics
          const [booksRes, usersRes, loansRes, returnsRes] = await Promise.all([
            fetch("/api/books"),
            fetch("/api/users"),
            fetch("/api/loans"),
            fetch("/api/returns"),
          ]);

          const books = await booksRes.json();
          const users = await usersRes.json();
          const loans = await loansRes.json();
          const returns = await returnsRes.json();

          // Update admin statistics (exclude admin accounts)
          document.getElementById("adminTotalBooks").textContent = books.length;
          const nonAdmin = users.filter(
            (u) => String(u.role || "").toLowerCase() !== "admin"
          );
          document.getElementById("adminTotalUsers").textContent =
            nonAdmin.length;

          const activeLoans = loans.filter((loan) => loan.status === "aktif");
          document.getElementById("adminActiveLoans").textContent =
            activeLoans.length;

          // Calculate overdue loans
          const today = new Date();
          const overdueLoans = activeLoans.filter((loan) => {
            const returnDate = new Date(loan.tanggalKembali);
            return today > returnDate;
          });
          document.getElementById("adminOverdueLoans").textContent =
            overdueLoans.length;

          // Prefill profile for current logged-in user (fallback: first admin)
          const meId = localStorage.getItem("userid");
          const me =
            users.find((u) => u.id === meId) ||
            users.find((u) => (u.role || "").toLowerCase() === "admin");
          if (me) {
            document.getElementById("profileEmail").textContent =
              me.email || "-";
            document.getElementById("detailEmail").textContent =
              me.email || "-";
            document.getElementById("profileUsername").textContent =
              me.username || me.nama || "admin";
            document.getElementById("detailUsername").textContent =
              me.username || me.nama || "admin";
            if (document.getElementById("editEmail"))
              document.getElementById("editEmail").value = me.email || "";
            if (document.getElementById("editUsername"))
              document.getElementById("editUsername").value =
                me.username || me.nama || "";
            if (document.getElementById("editName"))
              document.getElementById("editName").value =
                me.username || me.nama || "";
          }
        } catch (error) {
          console.error("Error loading profile data:", error);
        }
      }

      // Edit profile function
      function editProfile() {
        document.getElementById("viewProfile").style.display = "none";
        document.getElementById("editProfile").style.display = "block";
      }

      // Cancel edit profile function
      function cancelEditProfile() {
        document.getElementById("viewProfile").style.display = "block";
        document.getElementById("editProfile").style.display = "none";
        document.getElementById("profileMessage").innerHTML = "";
      }

      // Show admin settings
      function showAdminSettings() {
        showSection("settings");
      }

      // Update admin name in dropdown
      function updateAdminDropdown(displayName = null) {
        if (!displayName) {
          displayName =
            document.getElementById("editUsername")?.value ||
            document.getElementById("editName")?.value ||
            "Admin";
        }
        document.getElementById("adminDropdownName").textContent = displayName;
        document.getElementById(
          "adminName"
        ).textContent = `Halo, ${displayName} ðŸ‘‹`;
      }

      // Profile form submission
      document
        .getElementById("editProfileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const password = document.getElementById("editPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          if (password && password !== confirmPassword) {
            document.getElementById("profileMessage").innerHTML =
              '<div class="alert alert-danger">Password tidak cocok</div>';
            return;
          }

          if (password && password.length < 6) {
            document.getElementById("profileMessage").innerHTML =
              '<div class="alert alert-danger">Password minimal 6 karakter</div>';
            return;
          }

          // Update profile display
          const newName = document.getElementById("editName").value;
          const newUsername = document.getElementById("editUsername").value;
          const newEmail = document.getElementById("editEmail").value;
          const newBio = document.getElementById("editBio").value;

          // Persist to server
          try {
            const userId = localStorage.getItem("userid");
            if (userId) {
              const payload = { username: newUsername, email: newEmail };
              if (password) payload.password = password;
              const res = await fetch(
                `${API_BASE}/users/${encodeURIComponent(userId)}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                }
              );
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                document.getElementById(
                  "profileMessage"
                ).innerHTML = `<div class="alert alert-danger">Gagal menyimpan profil: ${
                  err.message || res.status
                }</div>`;
                return;
              }
            }
          } catch (err) {
            document.getElementById(
              "profileMessage"
            ).innerHTML = `<div class="alert alert-danger">Gagal terhubung ke server</div>`;
            return;
          }

          // Update view profile
          document.getElementById("profileName").textContent = newName;
          document.getElementById("profileUsername").textContent = newUsername;
          document.getElementById("profileEmail").textContent = newEmail;
          document.getElementById("detailName").textContent = newName;
          document.getElementById("detailUsername").textContent = newUsername;
          document.getElementById("detailEmail").textContent = newEmail;

          // Update dropdown and header using username
          updateAdminDropdown(newUsername || newName);

          document.getElementById("profileMessage").innerHTML =
            '<div class="alert alert-success">Profil berhasil diupdate</div>';

          // Reset password fields
          document.getElementById("editPassword").value = "";
          document.getElementById("confirmPassword").value = "";

          // Show success message for 3 seconds then switch back to view
          setTimeout(() => {
            document.getElementById("profileMessage").innerHTML = "";
            cancelEditProfile();
          }, 2000);
        });

      // Settings form submission
      document
        .getElementById("systemSettingsForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const settings = saveSystemSettings();

          // Persist to server
          try {
            const res = await fetch(`${API_BASE}/admin/settings`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(settings),
            });
            if (!res.ok) {
              const text = await res.text().catch(() => "");
              throw new Error(
                text || `Gagal menyimpan pengaturan (status ${res.status})`
              );
            }
            const data = await res.json().catch(() => ({ settings }));
            // Sync local cache with server-confirmed values
            if (data && data.settings) {
              localStorage.setItem(
                "systemSettings",
                JSON.stringify(data.settings)
              );
            } else {
              localStorage.setItem("systemSettings", JSON.stringify(settings));
            }
            // Reflect UI from latest values
            loadSystemSettings();
            document.getElementById("settingsMessage").innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>Pengaturan berhasil disimpan
          </div>
        `;
          } catch (err) {
            // Keep local changes but warn user the server save failed
            document.getElementById("settingsMessage").innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>Pengaturan tersimpan lokal, namun gagal menyimpan ke server. ${
              err.message || ""
            }
          </div>
        `;
          }

          // Hide message after 3 seconds
          setTimeout(() => {
            document.getElementById("settingsMessage").innerHTML = "";
          }, 3000);
        });

      // Event listeners
      document
        .getElementById("bookSearch")
        .addEventListener("input", searchBooks);
      document
        .getElementById("bookFilter")
        .addEventListener("change", searchBooks);
      document
        .getElementById("userSearch")
        .addEventListener("input", searchUsers);
      document
        .getElementById("userFilter")
        .addEventListener("change", searchUsers);

      // Profile form real-time updates
      document
        .getElementById("editName")
        .addEventListener("input", () => updateAdminDropdown());
      if (document.getElementById("editUsername")) {
        document
          .getElementById("editUsername")
          .addEventListener("input", () => updateAdminDropdown());
      }

      // Delete confirmation checkbox
      document
        .getElementById("confirmDelete")
        .addEventListener("change", function () {
          document.getElementById("confirmDeleteBtn").disabled = !this.checked;
        });

      // Return confirmation form
      document
        .getElementById("returnConfirmForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const returnData = Object.fromEntries(formData.entries());

          try {
            const response = await fetch(`${API_BASE}/admin/confirm-return`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(returnData),
            });

            const result = await response.json();

            if (response.ok) {
              document.getElementById("returnConfirmMessage").innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>${result.message}
              ${
                result.fine > 0
                  ? `<br><strong>Denda: Rp ${result.fine.toLocaleString()}</strong>`
                  : ""
              }
            </div>
          `;
              this.reset();
              // Refresh loan data
              loadLoanManagement();
              // Trigger live updates for user pages
              try {
                const timestamp = String(Date.now());
                localStorage.setItem("loans:updated", timestamp);
                localStorage.setItem("returns:updated", timestamp);
                console.log("Admin triggered live updates:", timestamp);

                // Also try to trigger update directly if user page is open
                setTimeout(() => {
                  try {
                    if (typeof window.triggerLiveUpdate === "function") {
                      window.triggerLiveUpdate();
                    }
                  } catch (e) {
                    console.log("Direct trigger not available (different tab)");
                  }
                }, 100);
              } catch (e) {
                console.error("Failed to trigger live updates:", e);
              }
            } else {
              document.getElementById("returnConfirmMessage").innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle me-2"></i>${result.message}
            </div>
          `;
            }
          } catch (error) {
            document.getElementById("returnConfirmMessage").innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>Terjadi kesalahan: ${error.message}
          </div>
        `;
          }
        });

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        // Preload saved settings from server and reflect globally (e.g., sidebar title)
        try {
          const res = await fetch(`${API_BASE}/admin/settings`);
          if (res.ok) {
            const settings = await res.json();
            try {
              localStorage.setItem("systemSettings", JSON.stringify(settings));
            } catch (_) {}
            const sidebarTitle = document.querySelector(".sidebar h4");
            if (sidebarTitle && settings && settings.libraryName) {
              sidebarTitle.textContent = `ðŸ“š ${settings.libraryName}`;
            }
          }
        } catch (_) {}

        // Show home section by default
        showSection("home");
      });
    </script>
    <script>
      // Live update when account switches in another tab/window
      window.addEventListener("storage", (e) => {
        if (e.key === "username" || e.key === "userid") {
          try {
            // Refresh visible admin section
            const active = document.querySelector(".admin-section.active");
            if (!active) {
              showSection("home");
              return;
            }
            const id = active.id.replace("-section", "");
            showSection(id);
            updateAdminDropdown();
          } catch (_) {}
        }
        if (
          e.key === "loans:updated" ||
          e.key === "returns:updated" ||
          e.key === "books:updated"
        ) {
          try {
            // Refresh dashboard counters and recent activity
            if (typeof loadDashboardData === "function") loadDashboardData();
            if (typeof loadLoanManagement === "function") loadLoanManagement();
            // If books section is active, refresh grid too
            const active = document.querySelector(".admin-section.active");
            if (active && active.id === "books-section") {
              if (typeof loadAllBooks === "function") loadAllBooks();
            }
          } catch (_) {}
        }
      });
    </script>
    <script>
      // Same-tab lightweight polling to keep dashboard and active section fresh without manual refresh
      (function () {
        setInterval(() => {
          try {
            const active = document.querySelector(".admin-section.active");
            // Always keep home dashboard numbers and recent activity fresh
            if (typeof loadDashboardData === "function") loadDashboardData();
            if (!active) return;
            if (active.id === "books-section") {
              if (typeof loadAllBooks === "function") loadAllBooks();
            } else if (active.id === "loans-section") {
              if (typeof loadLoanManagement === "function")
                loadLoanManagement();
            } else if (active.id === "reports-section") {
              // Avoid resetting user selections too frequently; refresh less often
              if (typeof loadReports === "function") {
                // Throttle: only refresh data every 10s for this section
                const now = Date.now();
                window.__lastReportsRefresh = window.__lastReportsRefresh || 0;
                if (now - window.__lastReportsRefresh > 10000) {
                  window.__lastReportsRefresh = now;
                  loadReports();
                }
              }
            } else if (active.id === "payments-section") {
              if (typeof loadPayments === "function") {
                loadPayments();
              }
            }
          } catch (_) {}
        }, 2000);
      })();
    </script>
    <script>
      // Same-tab live session detection (no manual refresh)
      (function () {
        let lastUid = localStorage.getItem("userid");
        let lastUname = localStorage.getItem("username");
        setInterval(() => {
          const uid = localStorage.getItem("userid");
          const uname = localStorage.getItem("username");
          if (uid !== lastUid || uname !== lastUname) {
            lastUid = uid;
            lastUname = uname;
            try {
              const active = document.querySelector(".admin-section.active");
              if (!active) {
                showSection("home");
                return;
              }
              const id = active.id.replace("-section", "");
              showSection(id);
              updateAdminDropdown();
            } catch (_) {}
          }
        }, 1000);
      })();

      // Load payments for admin
      async function loadPayments() {
        try {
          const response = await fetch(`${API_BASE}/payments`);
          const payments = await response.json();

          // Calculate summary statistics
          const today = new Date().toISOString().split("T")[0];
          const totalPayments = payments.reduce(
            (sum, p) => sum + (p.amount || 0),
            0
          );
          const todayPayments = payments
            .filter((p) => p.tanggalBayar === today)
            .reduce((sum, p) => sum + (p.amount || 0), 0);
          const totalTransactions = payments.length;

          // Get unpaid fines
          const unpaidResponse = await fetch(`${API_BASE}/payments/unpaid`);
          const unpaidData = await unpaidResponse.json();
          const unpaidFines =
            (unpaidData.totalUnpaid || 0) + (unpaidData.totalCurrent || 0);

          // Update summary cards
          document.getElementById(
            "totalPayments"
          ).textContent = `Rp ${totalPayments.toLocaleString()}`;
          document.getElementById(
            "todayPayments"
          ).textContent = `Rp ${todayPayments.toLocaleString()}`;
          document.getElementById(
            "unpaidFines"
          ).textContent = `Rp ${unpaidFines.toLocaleString()}`;
          document.getElementById("totalTransactions").textContent =
            totalTransactions.toString();

          // Filter payments based on current selections
          const statusFilter =
            document.getElementById("paymentStatus")?.value || "all";
          const methodFilter =
            document.getElementById("paymentMethod")?.value || "all";
          const fromDate = document.getElementById("paymentFrom")?.value;
          const toDate = document.getElementById("paymentTo")?.value;

          let filteredPayments = payments;

          if (statusFilter !== "all") {
            filteredPayments = filteredPayments.filter(
              (p) => p.status === statusFilter
            );
          }

          if (methodFilter !== "all") {
            filteredPayments = filteredPayments.filter(
              (p) => p.paymentMethod === methodFilter
            );
          }

          if (fromDate) {
            filteredPayments = filteredPayments.filter(
              (p) => p.tanggalBayar >= fromDate
            );
          }

          if (toDate) {
            filteredPayments = filteredPayments.filter(
              (p) => p.tanggalBayar <= toDate
            );
          }

          // Sort by payment date (newest first)
          filteredPayments.sort(
            (a, b) => new Date(b.tanggalBayar) - new Date(a.tanggalBayar)
          );

          // Render payments table
          const resultsContainer = document.getElementById("paymentResults");
          if (!resultsContainer) return;

          if (filteredPayments.length === 0) {
            resultsContainer.innerHTML = `
              <div class="text-center text-muted py-5">
                <i class="fas fa-credit-card fa-3x mb-3"></i>
                <h5>Tidak ada data pembayaran</h5>
                <p>Belum ada pembayaran yang sesuai dengan filter yang dipilih.</p>
              </div>
            `;
            return;
          }

          let html = `
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID Pembayaran</th>
                    <th>User</th>
                    <th>Jenis</th>
                    <th>Jumlah</th>
                    <th>Metode</th>
                    <th>Tanggal Bayar</th>
                    <th>Status</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
          `;

          filteredPayments.forEach((payment) => {
            const statusClass =
              payment.status === "completed"
                ? "success"
                : payment.status === "pending"
                ? "warning"
                : "danger";
            const statusText =
              payment.status === "completed"
                ? "Selesai"
                : payment.status === "pending"
                ? "Pending"
                : "Gagal";

            const typeText =
              payment.type === "active_loan"
                ? "Denda Peminjaman"
                : "Denda Pengembalian";

            html += `
              <tr>
                <td>${payment.id}</td>
                <td>${payment.nama || "Unknown"}</td>
                <td>${typeText}</td>
                <td class="fw-bold">Rp ${payment.amount.toLocaleString()}</td>
                <td>
                  <span class="badge bg-info">
                    ${
                      payment.paymentMethod === "cash"
                        ? "Tunai"
                        : payment.paymentMethod === "transfer"
                        ? "Transfer"
                        : payment.paymentMethod === "qris"
                        ? "QRIS"
                        : "E-Wallet"
                    }
                  </span>
                </td>
                <td>${payment.tanggalBayar}</td>
                <td>
                  <span class="badge bg-${statusClass}">${statusText}</span>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="viewPaymentDetails('${
                    payment.id
                  }')">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            `;
          });

          html += `
                </tbody>
              </table>
            </div>
          `;

          resultsContainer.innerHTML = html;
        } catch (error) {
          console.error("Error loading payments:", error);
          const resultsContainer = document.getElementById("paymentResults");
          if (resultsContainer) {
            resultsContainer.innerHTML = `
              <div class="text-center text-danger py-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Gagal memuat data pembayaran</h5>
                <p>Terjadi kesalahan saat memuat data. Silakan coba lagi.</p>
              </div>
            `;
          }
        }
      }

      // View payment details
      function viewPaymentDetails(paymentId) {
        // This could open a modal with detailed payment information
        alert(
          `Detail pembayaran ${paymentId}. Silakan cek riwayat dan data terkait.`
        );
      }
    </script>
  </body>
</html>
